<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>千早算数クエスト - 6年生分数版</title>
<style>
body{font-family:Arial,sans-serif;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform 0.3s;margin:20px 0}
.monster.level-up{animation:levelUp 2s}
.monster.correct{animation:correct 1s}
@keyframes levelUp{0%{transform:scale(1)}50%{transform:scale(2)rotate(180deg);color:#ff0}100%{transform:scale(1)rotate(360deg);color:gold}}
@keyframes correct{0%{transform:scale(1)}50%{transform:scale(1.3);color:#0f0}100%{transform:scale(1);color:gold}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
.status{margin:15px 0;font-size:18px}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:40px;margin:30px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:20px;min-width:200px}
.answer-section h3{margin:0 0 15px 0;color:#2196f3;font-size:18px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-input input{width:80px;text-align:center;margin:2px}
.fraction-line{width:90px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0}
.mixed-input input{width:60px;text-align:center}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px;margin:10px 0}
.normal-input input{width:120px;text-align:center}
.unit-display{font-size:16px;font-weight:bold;color:#666;margin-top:5px}
.submit-buttons{display:flex;justify-content:center;gap:20px;margin:20px 0}
.submit-btn{padding:15px 30px;font-size:18px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.submit-btn:disabled{background:#ccc;cursor:not-allowed}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #4caf50}
.comparison-options{display:flex;justify-content:center;gap:20px;margin:20px 0}
.comparison-btn{padding:15px 30px;font-size:18px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:30px}
</style>
</head>
<body>
<h1>🧮 千早算数クエスト - 6年生分数版</h1>

<div id="start">
<h2>小学6年生の分数をマスターしよう！</h2>
<div class="info">
<p><strong>📚 内容：</strong>分数の計算・比較・文章題（10段階レベル制）</p>
<p><strong>🎯 目標：</strong>レベル10でゲームクリア！各レベル5問ずつ</p>
<p><strong>❤️ ルール：</strong>間違えると体力減少。体力0でゲーム終了</p>
<p><strong>📝 注意：</strong>分数は必ず約分してから答えてください</p>
</div>
<div>
<input type="number" id="grade" value="6" min="1" max="6" placeholder="学年">年
<input type="number" id="class" min="1" max="10" placeholder="組">組
<input type="number" id="number" min="1" max="40" placeholder="番号">番
</div>
<button onclick="start()">スタート</button>
</div>

<div id="game" style="display:none">
<div class="info">レベル<span id="lv">1</span>/10 - <span id="lvInfo"></span></div>
<div class="monster" id="monster">📊</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>分数で答える</h3>
<div class="fraction-input">
<input type="number" id="numerator" placeholder="分子" min="0">
<div class="fraction-line"></div>
<input type="number" id="denominator" placeholder="分母" min="1">
</div>
<div id="fractionUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitFraction()">分数で答える</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>帯分数で答える</h3>
<div class="mixed-input">
<input type="number" id="mixedWhole" placeholder="整数" min="0">
<div class="fraction-input" style="margin:0">
<input type="number" id="mixedNumerator" placeholder="分子" min="0">
<div class="fraction-line"></div>
<input type="number" id="mixedDenominator" placeholder="分母" min="1">
</div>
</div>
<div id="mixedUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitMixed()">帯分数で答える</button>
</div>

<div class="answer-section">
<h3>整数か小数で答える</h3>
<div class="normal-input">
<input type="text" id="normalAnswer" placeholder="答えを入力">
<div id="normalUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">整数・小数で答える</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="submitComparison('left')">左の式</button>
<button class="comparison-btn" onclick="submitComparison('right')">右の式</button>
<button class="comparison-btn" onclick="submitComparison('equal')">同じ</button>
</div>

<div id="wrong" style="display:none">
<p id="wrongMsg">まちがいです。もう一度考えてみましょう。</p>
<div id="correctAnswerDisplay" class="correct-answer" style="display:none">
<strong>正解：</strong><span id="correctAnswerText"></span>
</div>
<button onclick="retry()">もう一度</button>
<button onclick="next()">つぎへ</button>
</div>
<div class="status">スコア: <span id="score">0</span> | HP: <span id="hp">❤️❤️❤️</span></div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>💀 ゲームオーバー 💀</h1>
<div class="monster" style="font-size:120px">😵</div>
<h2>残念！体力が0になりました</h2>
<div class="info">
<p>到達レベル: <span id="finalLevel"></span>/10</p>
<p>獲得スコア: <span id="finalScore1"></span>点</p>
</div>
<button onclick="restart()">もう一度</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>🎉 ゲームクリア！ 🎉</h1>
<div class="monster" style="font-size:120px">👑</div>
<h2>おめでとう！全レベル制覇！</h2>
<div class="info">最終スコア: <span id="finalScore2"></span>点</div>
<button onclick="restart()">もう一度</button>
</div>

<script>
const $=id=>document.getElementById(id);
let score=0,level=1,hp=3,ans,qNum=0,info="",currentProblem,currentUnit="";
const monsters=["📊","🔢","✖️","🔄","⚖️","➕","🔁","🔄","⏰","🏃"];
const levelNames=["分数×整数","分数÷整数","分数×分数","帯分数×帯分数","大小比較","計算の順序","分配法則","逆数","時間・分数","速さの文章題"];

function gcd(a,b){return b?gcd(b,a%b):a}
function simplify(n,d){const g=gcd(Math.abs(n),Math.abs(d));return[n/g,d/g]}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function randFrac(maxN=10,maxD=10){let n,d;do{n=rand(1,maxN);d=rand(2,maxD)}while(gcd(n,d)!==1||n>=d);return[n,d]}
function mixed2improper(w,n,d){return[w*d+n,d]}
function improper2mixed(n,d){return[Math.floor(n/d),n%d,d]}

// 分数を横線付きで表示する関数
function formatFraction(numerator, denominator) {
    return `<span class="fraction-display"><span class="numerator">${numerator}</span><span class="fraction-bar"></span><span class="denominator">${denominator}</span></span>`;
}

// 帯分数を横線付きで表示する関数
function formatMixedNumber(whole, numerator, denominator) {
    return `${whole} ${formatFraction(numerator, denominator)}`;
}

function generateProblem(level){
switch(level){
case 1:{ // 分数×整数
const [n,d]=randFrac(9,12);
const i=rand(2,8);
const [rn,rd]=simplify(n*i,d);
return {q:`${formatFraction(n,d)} × ${i} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(n*i)/d,allowMixed:false};
}
case 2:{ // 分数÷整数
const [n,d]=randFrac(8,10);
const i=rand(2,6);
const [rn,rd]=simplify(n,d*i);
return {q:`${formatFraction(n,d)} ÷ ${i} =`,a:`${rn}━${rd}`,type:'fraction',decimal:n/(d*i),allowMixed:false};
}
case 3:{ // 分数×分数
const [n1,d1]=randFrac(8,12);
const [n2,d2]=randFrac(8,12);
const [rn,rd]=simplify(n1*n2,d1*d2);
return {q:`${formatFraction(n1,d1)} × ${formatFraction(n2,d2)} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(n1*n2)/(d1*d2),allowMixed:false};
}
case 4:{ // 帯分数×帯分数 - 答えは仮分数で統一
const w1=rand(1,3),n1=rand(1,4),d1=rand(3,6);
const w2=rand(1,3),n2=rand(1,4),d2=rand(3,6);
const [i1,id1]=mixed2improper(w1,n1,d1);
const [i2,id2]=mixed2improper(w2,n2,d2);
const [rn,rd]=simplify(i1*i2,id1*id2);
return {q:`${formatMixedNumber(w1,n1,d1)} × ${formatMixedNumber(w2,n2,d2)} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(i1*i2)/(id1*id2),allowMixed:true};
}
case 5:{ // 大小比較
const [n1,d1]=randFrac(8,12);
const [n2,d2]=randFrac(8,12);
const val1=n1/d1,val2=n2/d2;
const expr1=`${formatFraction(n1,d1)} × ${formatFraction(n2,d2)}`;
const expr2=`${formatFraction(n1,d1)}`;
const result1=val1*val2,result2=val1;
let answer;
if(Math.abs(result1-result2)<0.0001)answer='equal';
else answer=result1>result2?'left':'right';
return {q:`${expr1} と ${expr2} どちらが大きいですか？`,a:answer,type:'comparison',left:expr1,right:expr2,allowMixed:false};
}
case 6:{ // 計算の順序
const [n1,d1]=randFrac(6,8);
const [n2,d2]=randFrac(6,8);
const i=rand(2,8);
// 分数の足し算を正確に計算
const addNum = n1*d2 + n2*d1;
const addDen = d1*d2;
const [addSimplifiedNum, addSimplifiedDen] = simplify(addNum, addDen);
// 結果に整数を掛ける
const [resultNum, resultDen] = simplify(addSimplifiedNum*i, addSimplifiedDen);
return {q:`(${formatFraction(n1,d1)} + ${formatFraction(n2,d2)}) × ${i} =`,a:`${resultNum}━${resultDen}`,type:'fraction',decimal:(resultNum/resultDen),allowMixed:false};
}
case 7:{ // 分配法則
const [n,d]=randFrac(6,10);
const a=rand(3,8),b=rand(3,8);
const [rn,rd]=simplify(n*(a+b),d);
return {q:`${formatFraction(n,d)} × ${a} + ${formatFraction(n,d)} × ${b} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(rn/rd),allowMixed:false};
}
case 8:{ // 逆数
const [n,d]=randFrac(8,12);
return {q:`${formatFraction(n,d)} の逆数を求めましょう`,a:`${d}━${n}`,type:'fraction',decimal:d/n,allowMixed:false};
}
case 9:{ // 時間・分数
const problems=[
()=>{
const m=rand(10,50);
const [rn,rd]=simplify(m,60);
return {q:`${m}分は何時間ですか？`,a:`${rn}━${rd}`,unit:"時間",type:'fraction',decimal:m/60,allowMixed:false}
},
()=>{
const s=rand(15,55);
const [rn,rd]=simplify(s,60);
return {q:`${s}秒は何分ですか？`,a:`${rn}━${rd}`,unit:"分",type:'fraction',decimal:s/60,allowMixed:false}
},
()=>{
const h=rand(15,45);
const [rn,rd]=simplify(h,24);
return {q:`${h}時間は何日ですか？`,a:`${rn}━${rd}`,unit:"日",type:'fraction',decimal:h/24,allowMixed:false}
}
];
return problems[rand(0,2)]();
}
case 10:{ // 速さの文章題 - 大きな数になりやすいので帯分数も許可
const problems=[
()=>{
const [n,d]=randFrac(6,10);
const t=rand(2,5);
const [rn,rd]=simplify(n*t,d);
return {q:`時速${formatFraction(n,d)}kmで${t}時間歩きました。何km進みましたか？`,a:`${rn}━${rd}`,unit:"km",type:'fraction',decimal:(n*t)/d,allowMixed:true};
},
()=>{
const [n,d]=randFrac(4,8);
const dist=rand(2,6);
const [rn,rd]=simplify(dist*d,n);
return {q:`${dist}kmの道のりを時速${formatFraction(n,d)}kmで歩きます。何時間かかりますか？`,a:`${rn}━${rd}`,unit:"時間",type:'fraction',decimal:(dist*d)/n,allowMixed:true};
}
];
return problems[rand(0,1)]();
}
}
}

function start(){
const g=$("grade").value||"6",c=$("class").value||"？",n=$("number").value||"？";
info=`${g}年${c}組${n}番`;
$("start").style.display="none";
$("game").style.display="block";
score=0;level=1;hp=3;qNum=0;
updateDisplay();
nextQ();
}

function updateDisplay(){
$("lv").textContent=level;
$("lvInfo").textContent=levelNames[level-1];
$("score").textContent=score;
$("hp").innerHTML="❤️".repeat(hp)||"💀";
$("monster").textContent=monsters[level-1];
}

function nextQ(){
if(qNum>=5){
if(level>=10){showClear();return}
level++;qNum=0;
$("monster").classList.add("level-up");
setTimeout(()=>$("monster").classList.remove("level-up"),2000);
}

currentProblem=generateProblem(level);
$("q").innerHTML=currentProblem.q;
ans=currentProblem.a;
currentUnit=currentProblem.unit||"";

// Clear inputs
$("numerator").value="";
$("denominator").value="";
$("mixedWhole").value="";
$("mixedNumerator").value="";
$("mixedDenominator").value="";
$("normalAnswer").value="";
$("wrong").style.display="none";
$("correctAnswerDisplay").style.display="none";

// Show/hide answer sections based on problem type
if(currentProblem.type==='comparison'){
$("answerSections").style.display="none";
$("comparisonInput").style.display="block";
}else{
$("answerSections").style.display="flex";
$("comparisonInput").style.display="none";
}

// Show mixed number section if allowed
if(currentProblem.allowMixed){
$("mixedSection").style.display="block";
}else{
$("mixedSection").style.display="none";
}

// Show units if present
if(currentUnit){
$("fractionUnit").textContent=currentUnit;
$("fractionUnit").style.display="block";
$("mixedUnit").textContent=currentUnit;
$("mixedUnit").style.display="block";
$("normalUnit").textContent=currentUnit;
$("normalUnit").style.display="block";
}else{
$("fractionUnit").style.display="none";
$("mixedUnit").style.display="none";
$("normalUnit").style.display="none";
}

updateDisplay();
$("numerator").focus();
}

function submitFraction(){
const num=parseInt($("numerator").value)||0;
const den=parseInt($("denominator").value)||1;
if(den===0){alert("分母は0にできません");return}
const[sn,sd]=simplify(num,den);
const userAns=`${sn}━${sd}`;
checkAnswer(userAns);
}

function submitMixed(){
const whole=parseInt($("mixedWhole").value)||0;
const num=parseInt($("mixedNumerator").value)||0;
const den=parseInt($("mixedDenominator").value)||1;
if(den===0){alert("分母は0にできません");return}
if(num===0&&whole===0){alert("答えを入力してください");return}

// Convert mixed to improper fraction
const [improperNum,improperDen]=mixed2improper(whole,num,den);
const[sn,sd]=simplify(improperNum,improperDen);
const userAns=`${sn}━${sd}`;
checkAnswer(userAns);
}

function submitNormal(){
let userAns=$("normalAnswer").value.trim();

// Convert decimal to fraction if needed for comparison
if(currentProblem.decimal && !isNaN(parseFloat(userAns))){
const userDecimal=parseFloat(userAns);
if(Math.abs(userDecimal-currentProblem.decimal)<0.0001){
checkAnswer(ans); // Correct decimal answer
return;
}
}

// Check if it's an integer that matches
if(currentProblem.decimal && userAns==Math.round(currentProblem.decimal)){
checkAnswer(ans);
return;
}

checkAnswer(userAns);
}

function submitComparison(choice){
checkAnswer(choice);
}

function checkAnswer(userAns){
if(userAns===ans){
score++;qNum++;
$("monster").classList.add("correct");
setTimeout(()=>$("monster").classList.remove("correct"),1000);
setTimeout(nextQ,1500);
}else{
hp--;
if(hp<=0){
showGameOver();
}else{
$("answerSections").style.display="none";
$("comparisonInput").style.display="none";
$("wrong").style.display="block";
$("correctAnswerDisplay").style.display="none";
}
}
}

function retry(){
if(currentProblem.type==='comparison'){
$("comparisonInput").style.display="block";
}else{
$("answerSections").style.display="flex";
}
$("wrong").style.display="none";
$("correctAnswerDisplay").style.display="none";
$("numerator").focus();
}

function next(){
displayCorrectAnswer();
setTimeout(()=>{qNum++;nextQ()},2000);
}

function displayCorrectAnswer(){
let displayAnswer;
if(currentProblem.type==='comparison'){
const choices={'left':'左の式','right':'右の式','equal':'同じ'};
displayAnswer=choices[ans];
}else{
// Convert ━ back to proper fraction display for answer
displayAnswer = ans.replace(/(\d+)━(\d+)/g, (match, num, den) => {
    return formatFraction(num, den);
}) + (currentUnit||"");
}
$("correctAnswerText").innerHTML=displayAnswer;
$("correctAnswerDisplay").style.display="block";
}

function showGameOver(){
$("game").style.display="none";
$("gameover").style.display="block";
$("finalLevel").textContent=level;
$("finalScore1").textContent=score;
}

function showClear(){
$("game").style.display="none";
$("clear").style.display="block";
$("finalScore2").textContent=score;
document.body.classList.add("clear-screen");
}

function restart(){location.reload()}

// Event listeners for Enter key
$("normalAnswer").addEventListener("keypress",e=>{if(e.key==="Enter")submitNormal()});
$("numerator").addEventListener("keypress",e=>{if(e.key==="Enter")$("denominator").focus()});
$("denominator").addEventListener("keypress",e=>{if(e.key==="Enter")submitFraction()});
$("mixedWhole").addEventListener("keypress",e=>{if(e.key==="Enter")$("mixedNumerator").focus()});
$("mixedNumerator").addEventListener("keypress",e=>{if(e.key==="Enter")$("mixedDenominator").focus()});
$("mixedDenominator").addEventListener("keypress",e=>{if(e.key==="Enter")submitMixed()});
</script>
</body>
</html>
