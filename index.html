<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 6å¹´ç”Ÿåˆ†æ•°ç‰ˆ</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform .3s;margin:20px 0}
.monster.level-up{animation:levelUp 3s}
.monster.correct{animation:correct 1.5s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{
    0%{transform:scale(1) rotate(0deg);color:#333}
    20%{transform:scale(1.5) rotate(90deg);color:#ff0;filter:drop-shadow(0 0 20px #ff0)}
    40%{transform:scale(2) rotate(180deg);color:#f0f;filter:drop-shadow(0 0 30px #f0f)}
    60%{transform:scale(2.5) rotate(270deg);color:#0ff;filter:drop-shadow(0 0 40px #0ff)}
    80%{transform:scale(3) rotate(360deg);color:#0f0;filter:drop-shadow(0 0 50px #0f0)}
    100%{transform:scale(1) rotate(360deg);color:gold;filter:drop-shadow(0 0 20px gold)}
}
@keyframes correct{
    0%{transform:scale(1);color:#333}
    25%{transform:scale(1.3) rotate(10deg);color:#0f0;filter:drop-shadow(0 0 15px #0f0)}
    50%{transform:scale(1.5) rotate(-10deg);color:#00ff00;filter:drop-shadow(0 0 25px #00ff00)}
    75%{transform:scale(1.3) rotate(5deg);color:#32cd32;filter:drop-shadow(0 0 20px #32cd32)}
    100%{transform:scale(1);color:gold;filter:drop-shadow(0 0 10px gold)}
}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
.mode-btn.select{background:#9c27b0}
.mode-btn.select:hover{background:#7b1fa2}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width .3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.progress-bar.select{background:#9c27b0}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.mode-info.select{background:#f3e5f5;color:#7b1fa2;border:2px solid #9c27b0}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 3s infinite}
@keyframes rainbow{
    0%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}
    25%{background:linear-gradient(45deg,#a8e6cf,#dcedc1);transform:scale(1.05)}
    50%{background:linear-gradient(45deg,#ffd93d,#ff6b6b);transform:scale(1.1)}
    75%{background:linear-gradient(45deg,#74b9ff,#0984e3);transform:scale(1.05)}
    100%{background:linear-gradient(45deg,#ff9a9e,#fecfef);transform:scale(1)}
}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-input input{width:70px;text-align:center;margin:2px}
.fraction-line{width:80px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:8px;margin:10px 0}
.mixed-input input{width:50px;text-align:center}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px}
.normal-input input{width:100px;text-align:center}
.unit-display{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
.submit-btn{padding:12px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.comparison-options{display:flex;justify-content:center;gap:15px;margin:20px 0}
.comparison-btn{padding:12px 25px;font-size:16px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.comparison-btn.selected{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:25px}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.almost-msg{background:#fff3e0;color:#f57c00;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #ff9800}
.level-select{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;max-width:600px;margin:20px auto}
.level-btn{padding:15px;background:#e3f2fd;border:2px solid #2196f3;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:all 0.3s}
.level-btn:hover{background:#2196f3;color:white;transform:scale(1.05)}
.level-btn h4{margin:5px 0;font-size:16px}
.level-btn p{margin:5px 0;font-size:12px;opacity:0.8}
.correct-celebration{
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    pointer-events:none;
    z-index:1000;
}
.firework{
    position:absolute;
    width:4px;height:4px;
    background:radial-gradient(circle,#ff0,#f00);
    border-radius:50%;
    animation:firework 2s ease-out forwards;
}
@keyframes firework{
    0%{transform:scale(1);opacity:1}
    100%{transform:scale(20);opacity:0}
}
.sparkle{
    position:absolute;
    width:2px;height:2px;
    background:#fff;
    border-radius:50%;
    animation:sparkle 1.5s ease-out infinite;
}
@keyframes sparkle{
    0%,100%{opacity:0;transform:scale(0)}
    50%{opacity:1;transform:scale(1)}
}
.nav-buttons{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:15px 0;
    flex-wrap:wrap;
}
.nav-btn{
    background:#6c757d;
    color:white;
    padding:8px 16px;
    font-size:14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.nav-btn:hover{
    background:#5a6268;
}
.timer{
    font-size:20px;
    font-weight:bold;
    color:#d32f2f;
    margin:10px 0;
    padding:10px;
    background:white;
    border-radius:8px;
    border:2px solid #f44336;
}
.ranking{
    background:white;
    border-radius:10px;
    padding:20px;
    margin:20px 0;
    border:2px solid #ffd700;
}
.ranking h3{
    color:#d32f2f;
    margin-bottom:15px;
}
.ranking-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 15px;
    margin:5px 0;
    border-radius:5px;
    background:#f8f9fa;
}
.ranking-item.current{
    background:#e8f5e8;
    border:2px solid #4caf50;
    font-weight:bold;
}
.rank-medal{
    font-size:20px;
    margin-right:10px;
}
</style>
</head>
<body>
<h1>ğŸ§® åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 6å¹´ç”Ÿåˆ†æ•°ç‰ˆ</h1>

<div id="start">
<h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="info">
<div class="mode-info select">
<h3>ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å¥½ããªãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ç·´ç¿’<br>â€¢ ä½•åº¦ã§ã‚‚æŒ‘æˆ¦å¯èƒ½</p>
</div>
<div class="mode-info practice">
<h3>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å„ãƒ¬ãƒ™ãƒ«ã§5å•é€£ç¶šæ­£è§£ã§æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸<br>â€¢ é–“é•ãˆãŸã‚‰ãã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚‹</p>
</div>
<div class="mode-info summary">
<h3>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</h3>
<p>â€¢ å…¨9ãƒ¬ãƒ™ãƒ«Ã—å„5å•ï¼è¨ˆ45å•ã«æŒ‘æˆ¦<br>â€¢ ä¸€å•ã§ã‚‚é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼<br>â€¢ ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æŒ‘æˆ¦ï¼</p>
</div>
</div>
<button class="mode-btn select" onclick="showLevelSelect()">ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn practice" onclick="selectMode('practice')">ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn" onclick="selectMode('summary')">ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<div id="levelSelect" style="display:none">
<h2>ğŸ® ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="level-select">
<div class="level-btn" onclick="selectLevel(1)">
<h4>ğŸ“Š ãƒ¬ãƒ™ãƒ«1</h4>
<p>åˆ†æ•°Ã—æ•´æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(2)">
<h4>ğŸ”¢ ãƒ¬ãƒ™ãƒ«2</h4>
<p>åˆ†æ•°Ã·æ•´æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(3)">
<h4>ğŸ”² ãƒ¬ãƒ™ãƒ«3</h4>
<p>åˆ†æ•°Ã—åˆ†æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(4)">
<h4>ğŸ”„ ãƒ¬ãƒ™ãƒ«4</h4>
<p>å¸¯åˆ†æ•°Ã—å¸¯åˆ†æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(5)">
<h4>â­ ãƒ¬ãƒ™ãƒ«5</h4>
<p>åˆ†æ•°Ã—åˆ†æ•°Ã—åˆ†æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(6)">
<h4>âš–ï¸ ãƒ¬ãƒ™ãƒ«6</h4>
<p>å¤§å°æ¯”è¼ƒ</p>
</div>
<div class="level-btn" onclick="selectLevel(7)">
<h4>ğŸ’¡ ãƒ¬ãƒ™ãƒ«7</h4>
<p>é€†æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(8)">
<h4>ğŸƒ ãƒ¬ãƒ™ãƒ«8</h4>
<p>æ™‚é–“ã®åˆ†æ•°</p>
</div>
<div class="level-btn" onclick="selectLevel(9)">
<h4>ğŸ‘‘ ãƒ¬ãƒ™ãƒ«9</h4>
<p>åˆ†æ•°ã®æ–‡ç« é¡Œ</p>
</div>
</div>
<button onclick="backToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«ã‚‚ã©ã‚‹</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>ãƒ¬ãƒ™ãƒ«<span id="lv">1</span>/9 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
</div>

<div id="timerDisplay" class="timer" style="display:none">
â±ï¸ çµŒéæ™‚é–“: <span id="timer">00:00</span>
</div>

<div class="nav-buttons">
<button class="nav-btn" onclick="backToStart()">ãƒˆãƒƒãƒ—ç”»é¢ã«ã‚‚ã©ã‚‹</button>
<button class="nav-btn" id="levelSelectBtn" onclick="backToLevelSelect()" style="display:none">ãƒ¬ãƒ™ãƒ«é¸æŠã«ã‚‚ã©ã‚‹</button>
</div>

<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">ğŸ“Š</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>åˆ†æ•°ã§ç­”ãˆã‚‹ï¼ˆå¿…ãšç´„åˆ†ï¼‰</h3>
<div class="fraction-input">
<input type="number" id="n" placeholder="åˆ†å­" min="0">
<div class="fraction-line"></div>
<input type="number" id="d" placeholder="åˆ†æ¯" min="1">
</div>
<div id="fUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitFraction()">åˆ†æ•°ã§ç­”ãˆã‚‹</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>å¸¯åˆ†æ•°ã§ç­”ãˆã‚‹ï¼ˆå¿…ãšç´„åˆ†ï¼‰</h3>
<div class="mixed-input">
<input type="number" id="mw" placeholder="æ•´æ•°" min="0">
<div class="fraction-input" style="margin:0">
<input type="number" id="mn" placeholder="åˆ†å­" min="0">
<div class="fraction-line"></div>
<input type="number" id="md" placeholder="åˆ†æ¯" min="1">
</div>
</div>
<div id="mUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitMixed()">å¸¯åˆ†æ•°ã§ç­”ãˆã‚‹</button>
</div>

<div class="answer-section">
<h3>æ•´æ•°ãƒ»å°æ•°ã§ç­”ãˆã‚‹</h3>
<div class="normal-input">
<input type="text" id="norm" placeholder="ç­”ãˆã‚’å…¥åŠ›">
<div id="nUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">æ•´æ•°ãƒ»å°æ•°ã§ç­”ãˆã‚‹</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="selectComparison(this, 'left')">å·¦ãŒã‚</button>
<button class="comparison-btn" onclick="selectComparison(this, 'right')">å³ãŒã‚</button>
<button class="comparison-btn" onclick="selectComparison(this, 'equal')">åŒã˜</button>
<br>
<button class="submit-btn" onclick="submitComparison()" style="margin-top:15px">ç­”ãˆã‚‹</button>
</div>

<div id="wrong" style="display:none">
<div id="almostMsg" class="almost-msg" style="display:none">
<strong>ãŠã—ã„ï¼ç´„åˆ†ã§ãã¾ã™</strong><br><span id="almostText"></span>
</div>
<div id="wrongMsg" class="error-msg">ã¾ã¡ãŒã„ã§ã™ã€‚</div>
<div id="correctAnswer" class="correct-answer" style="display:none">
<strong>æ­£è§£ï¼š</strong><span id="correctText"></span>
</div>
<div id="practiceMsg" style="display:none"><p>ã“ã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚Šã¾ã™ã€‚é ‘å¼µã£ã¦ï¼</p></div>
<div id="selectMsg" style="display:none"><p>ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼</p></div>
<button onclick="retry()">ã‚‚ã†ä¸€åº¦</button>
<button onclick="next()">ã¤ãã¸</button>
<button id="backToSelectBtn" onclick="backToLevelSelect()" style="display:none">ãƒ¬ãƒ™ãƒ«é¸æŠã«æˆ»ã‚‹</button>
</div>

<div class="status">
<span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 45å•ä¸­</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
<div class="monster" style="font-size:120px">ğŸ˜µ</div>
<h2>æ®‹å¿µï¼</h2>
<div class="info">
<p>åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="finalLv"></span>/9</p>
<p>æ­£è§£æ•°: <span id="finalScore1"></span>å•</p>
<p id="finalTime" style="display:none">çµŒéæ™‚é–“: <span id="finalTimeValue"></span></p>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ‘‘</div>
<h2>ãŠã‚ã§ã¨ã†ï¼å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼</h2>
<div class="info">
<p>æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore2"></span>å•æ­£è§£</p>
<p id="clearTime">ã‚¯ãƒªã‚¢æ™‚é–“: <span id="clearTimeValue"></span></p>
</div>
<div id="rankingDisplay" class="ranking" style="display:none">
<h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
<div id="rankingList"></div>
</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="celebration" class="correct-celebration"></div>

<script>
const $ = id => document.getElementById(id);
let state = {score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null};
const monsters = ["ğŸ“Š","ğŸ”¢","ğŸ”²","ğŸ”„","â­","âš–ï¸","ğŸ’¡","ğŸƒ","ğŸ‘‘"];
const lvNames = ["åˆ†æ•°Ã—æ•´æ•°","åˆ†æ•°Ã·æ•´æ•°","åˆ†æ•°Ã—åˆ†æ•°","å¸¯åˆ†æ•°Ã—å¸¯åˆ†æ•°","åˆ†æ•°Ã—åˆ†æ•°Ã—åˆ†æ•°","å¤§å°æ¯”è¼ƒ","é€†æ•°","æ™‚é–“ã®åˆ†æ•°","åˆ†æ•°ã®æ–‡ç« é¡Œ"];

const gcd = (a,b) => b ? gcd(b,a%b) : a;
const R = (min,max) => Math.floor(Math.random()*(max-min+1))+min;

function simplify(n,d){
    if(d<0){n=-n;d=-d}
    const g=gcd(Math.abs(n),Math.abs(d));
    return[n/g,d/g];
}

function randFrac(maxN=10,maxD=10){
    let n,d;
    do{n=R(1,maxN);d=R(2,maxD)}while(gcd(n,d)!==1||n>=d);
    return[n,d];
}

function frac(n,d){
    return`<span class="fraction-display"><span class="numerator">${n}</span><span class="fraction-bar"></span><span class="denominator">${d}</span></span>`;
}

function mixedFrac(w,n,d){
    if(n>=d){w+=Math.floor(n/d);n=n%d}
    return n===0?`${w}`:`${w} ${frac(n,d)}`;
}

function formatAnswer(n,d,u=""){
    const[sn,sd]=simplify(n,d);
    return sd===1?sn+u:`${sn}/${sd}`+u;
}

function formatTime(seconds){
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
}

function startTimer(){
    if(state.mode === 'summary'){
        state.startTime = Date.now();
        $("timerDisplay").style.display = "block";
        state.timerInterval = setInterval(updateTimer, 1000);
    }
}

function updateTimer(){
    if(state.startTime){
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        $("timer").textContent = formatTime(elapsed);
    }
}

function stopTimer(){
    if(state.timerInterval){
        clearInterval(state.timerInterval);
        state.timerInterval = null;
    }
}

function getElapsedTime(){
    if(state.startTime){
        return Math.floor((Date.now() - state.startTime) / 1000);
    }
    return 0;
}

function saveRanking(time){
    let rankings = JSON.parse(localStorage.getItem('fractionQuestRankings') || '[]');
    rankings.push({time: time, date: new Date().toISOString()});
    rankings.sort((a, b) => a.time - b.time);
    rankings = rankings.slice(0, 100); // ä¸Šä½100ä½ã¾ã§ä¿å­˜
    localStorage.setItem('fractionQuestRankings', JSON.stringify(rankings));
    return rankings;
}

function displayRanking(currentTime){
    const rankings = saveRanking(currentTime);
    const currentRank = rankings.findIndex(r => r.time === currentTime && r.date === rankings.find(rank => rank.time === currentTime).date) + 1;
    
    $("rankingDisplay").style.display = "block";
    const rankingList = $("rankingList");
    rankingList.innerHTML = "";
    
    // è‡ªåˆ†ã®é †ä½ã‚’è¡¨ç¤º
    const myRankDiv = document.createElement("div");
    myRankDiv.className = "ranking-item current";
    myRankDiv.innerHTML = `
        <span><strong>ã‚ãªãŸã®é †ä½: ${currentRank}ä½</strong></span>
        <span><strong>${formatTime(currentTime)}</strong></span>
    `;
    rankingList.appendChild(myRankDiv);
    
    // ãƒˆãƒƒãƒ—3ã‚’è¡¨ç¤º
    const medals = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"];
    for(let i = 0; i < Math.min(3, rankings.length); i++){
        const rankDiv = document.createElement("div");
        rankDiv.className = "ranking-item";
        if(i === currentRank - 1) rankDiv.classList.add("current");
        
        rankDiv.innerHTML = `
            <span><span class="rank-medal">${medals[i]}</span>${i + 1}ä½</span>
            <span>${formatTime(rankings[i].time)}</span>
        `;
        
        if(i < currentRank - 1 || currentRank > 3){
            rankingList.appendChild(rankDiv);
        }
    }
}

function createFireworks(){
    const celebration = $("celebration");
    celebration.innerHTML = "";
    
    for(let i = 0; i < 15; i++){
        setTimeout(() => {
            const firework = document.createElement("div");
            firework.className = "firework";
            firework.style.left = Math.random() * window.innerWidth + "px";
            firework.style.top = Math.random() * window.innerHeight + "px";
            firework.style.background = `radial-gradient(circle, hsl(${Math.random()*360}, 100%, 50%), hsl(${Math.random()*360}, 100%, 70%))`;
            celebration.appendChild(firework);
            
            setTimeout(() => firework.remove(), 2000);
        }, i * 100);
    }
    
    for(let i = 0; i < 30; i++){
        setTimeout(() => {
            const sparkle = document.createElement("div");
            sparkle.className = "sparkle";
            sparkle.style.left = Math.random() * window.innerWidth + "px";
            sparkle.style.top = Math.random() * window.innerHeight + "px";
            celebration.appendChild(sparkle);
            
            setTimeout(() => sparkle.remove(), 1500);
        }, i * 50);
    }
}

function setFocus(){
    setTimeout(()=>{
        if(state.prob?.type==='comparison'){
            return;
        }else{
            const input=$("mixedSection").style.display==="block"?$("md"):$("d");
            if(input)input.focus();
        }
    },150);
}

document.addEventListener('keydown',(e)=>{
    if(e.key==='Enter'&&e.target.tagName==='INPUT'){
        e.preventDefault();
        if(e.target.id==='n'||e.target.id==='d')submitFraction();
        else if(['mw','mn','md'].includes(e.target.id))submitMixed();
        else if(e.target.id==='norm')submitNormal();
    }
    if(state.prob?.type==='comparison'){
        if(e.key==='1'){
            selectComparison(document.querySelector('.comparison-btn[onclick*="left"]'), 'left');
        }
        else if(e.key==='2'){
            selectComparison(document.querySelector('.comparison-btn[onclick*="right"]'), 'right');
        }
        else if(e.key==='3'){
            selectComparison(document.querySelector('.comparison-btn[onclick*="equal"]'), 'equal');
        }
        else if(e.key==='Enter'&&state.selectedComparison){
            submitComparison();
        }
    }
});

function showLevelSelect(){
    $("start").style.display="none";
    $("levelSelect").style.display="block";
}

function backToStart(){
    stopTimer();
    $("levelSelect").style.display="none";
    $("game").style.display="none";
    $("start").style.display="block";
    $("timerDisplay").style.display="none";
}

function selectLevel(lv){
    state={score:0,level:lv,prob:null,unit:"",mode:"select",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null};
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function backToLevelSelect(){
    stopTimer();
    $("game").style.display="none";
    $("levelSelect").style.display="block";
    $("timerDisplay").style.display="none";
}

function selectMode(m){
    state={score:0,level:1,prob:null,unit:"",mode:m,lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null};
    $("start").style.display="none";
    $("game").style.display="block";
    updateDisplay();
    updateLevelIndicator();
    if(m === 'summary'){
        startTimer();
    }
    nextQ();
}

function updateDisplay(){
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[state.level-1];
    $("score").textContent=state.score;
    $("monster").textContent=monsters[state.level-1];

    // é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    if(state.mode === 'select'){
        $("levelSelectBtn").style.display = "inline-block";
    } else {
        $("levelSelectBtn").style.display = "none";
    }

    const bar=$("progressBar");
    if(state.mode==='practice'){
        $("modeDisplay").innerHTML='<div class="mode-info practice"><strong>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`ã“ã®ãƒ¬ãƒ™ãƒ«: ${state.lvCount}/5å•æ­£è§£`;
        bar.className="progress-bar practice";
        bar.style.width=`${(state.lvCount/5)*100}%`;
        $("totalQ").style.display="none";
    }else if(state.mode==='select'){
        $("modeDisplay").innerHTML='<div class="mode-info select"><strong>ğŸ® é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`å•é¡Œæ•°: ${state.selectQCount}å•`;
        bar.className="progress-bar select";
        bar.style.width=`${Math.min((state.selectQCount/10)*100,100)}%`;
        $("totalQ").style.display="none";
    }else{
        $("modeDisplay").innerHTML='<div class="mode-info summary"><strong>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent=`å•é¡Œ ${state.totalQ+1}/45`;
        bar.className="progress-bar summary";
        bar.style.width=`${(state.totalQ/45)*100}%`;
        $("totalQ").style.display="inline";
        $("totalQ").textContent=" / 45å•ä¸­";
    }
}

function updateLevelIndicator(){
    const ind=$("levelIndicator");
    ind.innerHTML="";
    for(let i=1;i<=9;i++){
        const dot=document.createElement("div");
        dot.className="level-dot";
        dot.textContent=i;
        if(state.completed.has(i))dot.classList.add("completed");
        else if(i===state.level)dot.classList.add("current");
        ind.appendChild(dot);
    }
}

function generateProblem(lv){
    switch(lv){
        case 1:{
            const[n,d]=randFrac(9,12);
            const i=R(2,8);
            return{q:`${frac(n,d)} Ã— ${i} =`,n:n*i,d:d,type:'fraction',mixed:false};
        }
        case 2:{
            const[n,d]=randFrac(8,10);
            const i=R(2,6);
            return{q:`${frac(n,d)} Ã· ${i} =`,n:n,d:d*i,type:'fraction',mixed:false};
        }
        case 3:{
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(8,12);
            return{q:`${frac(n1,d1)} Ã— ${frac(n2,d2)} =`,n:n1*n2,d:d1*d2,type:'fraction',mixed:false};
        }
        case 4:{
            const w1=R(1,3),d1=R(3,6),n1=R(1,d1-1);
            const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);
            const i1=w1*d1+n1,i2=w2*d2+n2;
            return{q:`${mixedFrac(w1,n1,d1)} Ã— ${mixedFrac(w2,n2,d2)} =`,n:i1*i2,d:d1*d2,type:'fraction',mixed:true};
        }
        case 5:{
            const[n1,d1]=randFrac(6,8);
            const[n2,d2]=randFrac(6,8);
            const[n3,d3]=randFrac(6,8);
            return{q:`${frac(n1,d1)} Ã— ${frac(n2,d2)} Ã— ${frac(n3,d3)} =`,n:n1*n2*n3,d:d1*d2*d3,type:'fraction',mixed:false};
        }
        case 6:{
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(8,12);
            const v1=n1/d1,v2=n2/d2;
            const mult=R(2,4);
            const patterns=[
                {e1:`${frac(n1,d1)} Ã— ${frac(n2,d2)}`,e2:`${frac(n1,d1)}`,v1:v1*v2,v2:v1},
                {e1:`${frac(n1,d1)} Ã— ${mult}`,e2:`${frac(n1,d1)}`,v1:v1*mult,v2:v1}
            ];
            const p=patterns[R(0,1)];
            return{
                q:`${p.e1} ã¨ ${p.e2} ã©ã¡ã‚‰ãŒå¤§ãã„ã§ã™ã‹ï¼Ÿ<br><small>ï¼ˆ1:å·¦ãŒã‚ 2:å³ãŒã‚ 3:åŒã˜ï¼‰</small>`,
                a:Math.abs(p.v1-p.v2)<0.0001?'equal':p.v1>p.v2?'left':'right',
                type:'comparison',mixed:false
            };
        }
        case 7:{
            const[n,d]=randFrac(8,12);
            return{q:`${frac(n,d)} ã®é€†æ•°ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†`,n:d,d:n,type:'fraction',mixed:false};
        }
        case 8:{
            const patterns=[
                ()=>{const m=R(10,50);return{q:`${m}åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ`,n:m,d:60,u:"æ™‚é–“",type:'fraction',mixed:false};},
                ()=>{const s=R(15,120);return{q:`${s}ç§’ã¯ä½•åˆ†ã§ã™ã‹ï¼Ÿ`,n:s,d:60,u:"åˆ†",type:'fraction',mixed:false};},
                ()=>{const h=R(6,20);return{q:`${h}æ™‚é–“ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ`,n:h,d:24,u:"æ—¥",type:'fraction',mixed:false};}
            ];
            return patterns[R(0,2)]();
        }
        case 9:{
            const patterns=[
                ()=>{const t=R(12,24);const[n,d]=randFrac(4,8);return{q:`${t}å€‹ã®ãŠè“å­ã®${frac(n,d)}ã¯ä½•å€‹ã§ã™ã‹ï¼Ÿ`,n:t*n,d:d,u:"å€‹",type:'fraction',mixed:true};},
                ()=>{const t=R(6,15);const div=R(2,5);return{q:`${t}å€‹ã®ã‚Šã‚“ã”ã‚’${div}äººã§ç­‰ã—ãåˆ†ã‘ã‚‹ã¨ã€1äººã‚ãŸã‚Šä½•å€‹ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,n:t,d:div,u:"å€‹",type:'fraction',mixed:true};},
                ()=>{const[n,d]=randFrac(6,10);const w=R(8,20);return{q:`${w}mã®ãƒªãƒœãƒ³ã®${frac(n,d)}ã®é•·ã•ã¯ä½•mã§ã™ã‹ï¼Ÿ`,n:w*n,d:d,u:"m",type:'fraction',mixed:false};}
            ];
            return patterns[R(0,2)]();
        }
    }
}

function nextQ(){
    if(state.mode==='practice'){
        if(state.lvCount>=5){
            state.completed.add(state.level);
            if(state.level>=9){showClear();return;}
            state.level++;
            state.lvCount=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }else if(state.mode==='select'){
        // é¸ã¹ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã¯åŒã˜ãƒ¬ãƒ™ãƒ«ã‚’ç¶™ç¶š
    }else{
        if(state.level>=9&&state.qNum>=5){showClear();return;}
        if(state.qNum>=5){
            state.completed.add(state.level);
            state.level++;
            state.qNum=0;
            animate("level-up");
            updateLevelIndicator();
        }
    }

    state.prob=generateProblem(state.level);
    state.selectedComparison=null;
    $("q").innerHTML=state.prob.q;
    state.unit=state.prob.u||"";

    clearInputs();
    $("wrong").style.display="none";

    if(state.prob.type==='comparison'){
        $("answerSections").style.display="none";
        $("comparisonInput").style.display="block";
        document.querySelectorAll('.comparison-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
    }else{
        $("answerSections").style.display="flex";
        $("comparisonInput").style.display="none";
    }

    $("mixedSection").style.display=state.prob.mixed?"block":"none";

    const show=state.unit?"block":"none";
    ["fUnit","mUnit","nUnit"].forEach(id=>{
        $(id).textContent=state.unit;
        $(id).style.display=show;
    });

    updateDisplay();
    setFocus();
}

function clearInputs(){
    ["n","d","mw","mn","md","norm"].forEach(id=>$(id).value="");
}

function animate(cls){
    $("monster").classList.add(cls);
    if(cls === "correct"){
        createFireworks();
    }
    setTimeout(()=>$("monster").classList.remove(cls),cls==="level-up"?3000:1500);
}

function selectComparison(btn, choice){
    document.querySelectorAll('.comparison-btn').forEach(b => {
        b.classList.remove('selected');
    });
    btn.classList.add('selected');
    state.selectedComparison = choice;
}

function submitFraction(){
    const num=parseInt($("n").value)||0;
    const den=parseInt($("d").value)||1;
    if(den===0){showError("åˆ†æ¯ã¯0ã«ã§ãã¾ã›ã‚“");return;}
    if(num===0&&den===1){showError("åˆ†å­ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    checkAnswer(num,den);
}

function submitMixed(){
    const w=parseInt($("mw").value)||0;
    const num=parseInt($("mn").value)||0;
    const den=parseInt($("md").value)||1;
    if(num===0&&w===0){showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    if(den===0){showError("åˆ†æ¯ã¯0ã«ã§ãã¾ã›ã‚“");return;}
    if(num>=den&&den>0&&num>0){showError("å¸¯åˆ†æ•°ã®åˆ†å­ã¯åˆ†æ¯ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„");return;}
    checkAnswer(w*den+num,den);
}

function submitNormal(){
    const ans=$("norm").value.trim();
    if(!ans){showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    const userDec=parseFloat(ans);
    const correctDec=state.prob.n/state.prob.d;
    const isCorrect=!isNaN(userDec)&&Math.abs(userDec-correctDec)<0.0001;
    handleAnswer(isCorrect,formatAnswer(state.prob.n,state.prob.d,state.unit));
}

function submitComparison(){
    if(!state.selectedComparison){
        showError("é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„");
        return;
    }
    handleAnswer(state.selectedComparison===state.prob.a,"æ¯”è¼ƒå•é¡Œ");
}

function checkAnswer(un,ud){
    const[cn,cd]=simplify(state.prob.n,state.prob.d);
    const[sn,sd]=simplify(un,ud);
    
    const userGcd = gcd(Math.abs(un), Math.abs(ud));
    const needsSimplification = userGcd > 1;
    
    const isCorrect = sn === cn && sd === cd && !needsSimplification;
    const correctAns = formatAnswer(cn, cd, state.unit);
    
    if (needsSimplification) {
        const [rn, rd] = simplify(un, ud);
        $("almostMsg").style.display = "block";
        $("almostText").textContent = `${un}/${ud} = ${rn}/${rd}`;
        
        handleAnswer(false, correctAns);
        return;
    }
    
    handleAnswer(isCorrect, correctAns);
}

function handleAnswer(isCorrect,correctAns){
    if(isCorrect){
        state.score++;
        if(state.mode==='practice')state.lvCount++;
        else if(state.mode==='select')state.selectQCount++;
        else{state.qNum++;state.totalQ++;}
        animate("correct");
        setTimeout(nextQ,2000);
    }else{
        $("wrong").style.display="block";
        if(state.prob.type!=='comparison'){
            $("correctAnswer").style.display="block";
            $("correctText").textContent=correctAns;
        }
        if(state.mode==='practice'){
            state.lvCount=0;
            $("practiceMsg").style.display="block";
        }else if(state.mode==='select'){
            $("selectMsg").style.display="block";
            $("backToSelectBtn").style.display="inline-block";
        }else{
            showGameOver();
            return;
        }
        animate("wrong");
    }
}

function showError(msg){
    $("wrongMsg").textContent=msg;
    $("wrong").style.display="block";
    $("correctAnswer").style.display="none";
    $("practiceMsg").style.display="none";
    $("selectMsg").style.display="none";
    $("almostMsg").style.display="none";
    $("backToSelectBtn").style.display="none";
}

function retry(){
    $("wrong").style.display="none";
    $("almostMsg").style.display="none";
    clearInputs();
    if(state.prob?.type==='comparison'){
        state.selectedComparison=null;
        document.querySelectorAll('.comparison-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
    }
    setFocus();
}

function next(){
    nextQ();
}

function showGameOver(){
    stopTimer();
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode === 'summary'){
        const elapsedTime = getElapsedTime();
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(elapsedTime);
    }
}

function showClear(){
    stopTimer();
    createFireworks();
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    
    if(state.mode === 'summary'){
        const elapsedTime = getElapsedTime();
        $("clearTimeValue").textContent=formatTime(elapsedTime);
        displayRanking(elapsedTime);
    }
}

function restart(){
    stopTimer();
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("start").style.display="block";
    $("timerDisplay").style.display="none";
    state={score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set(),selectedComparison:null,selectQCount:0,startTime:null,timerInterval:null};
}
</script>
</body>
</html>
