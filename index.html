function getElapsedTime(){
    return state.startTime?Math.floor((Date.now()-state.startTime)/1000):0;
}

function generateHiddenProblem(){
    const type=R(1,5);
    switch(type){
        case 1:{
            const[n1,d1]=randFrac(12,15);
            const[n2,d2]=randFrac(12,15);
            const[n3,d3]=randFrac(12,15);
            const[n4,d4]=randFrac(12,15);
            return{q:`${frac(n1,d1)} × ${frac(n2,d2)} × ${frac(n3,d3)} × ${frac(n4,d4)} =`,n:n1*n2*n3*n4,d:d1*d2*d3*d4,type:'fraction',mixed:false};
        }
        case 2:{
            const w1=R(2,4),d1=R(5,8),n1=R(1,d1-1);
            const w2=R(2,4),d2=R(5,8),n2=R(1,d2-1);
            const w3=R(1,3),d3=R(4,6),n3=R(1,d3-1);
            const i1=w1*d1+n1,i2=w2*d2+n2,i3=w3*d3+n3;
            return{q:`${mixedFrac(w1,n1,d1)} × ${mixedFrac(w2,n2,d2)} × ${mixedFrac(w3,n3,d3)} =`,n:i1*i2*i3,d:d1*d2*d3,type:'fraction',mixed:true};
        }
        case 3:{
            const[n1,d1]=randFrac(15,20);
            const[n2,d2]=randFrac(15,20);
            const[n3,d3]=randFrac(15,20);
            return{q:`${frac(n1,d1)} ÷ ${frac(n2,d2)} × ${frac(n3,d3)} =`,n:n1*d2*n3,d:d1*n2*d3,type:'fraction',mixed:false};
        }
        case 4:{
            const total=R(100,200);
            const[n1,d1]=randFrac(8,15);
            const[n2,d2]=randFrac(8,15);
            const remaining=total*(d1-n1)/d1;
            return{q:`${total}個のお菓子があります。最初に全体の${frac(n1,d1)}を食べ、残りの${frac(n2,d2)}をさらに食べました。最後に残ったお菓子は何個ですか？`,n:remaining*(d2-n2),d:d2,u:"個",type:'fraction',mixed:false};
        }
        case 5:{
            const[n1,d1]=randFrac(20,30);
            const[n2,d2]=randFrac(20,30);
            const[n3,d3]=randFrac(20,30);
            return{q:`${frac(n1,d1)}、${frac(n2,d2)}、${frac(n3,d3)} の中で最も大きいものを分数で答えてください`,left:Math.max(n1*d2*d3,n2*d1*d3,n3*d1*d2),right:d1*d2*d3,type:'max_fraction'};
        }
    }
}

function generateProblem(lv){
    if(state.mode==='hidden')return generateHiddenProblem();
    switch(lv){
        case 1:{
            const[n,d]=randFrac(9,12);
            const i=R(2,8);
            return{q:`${frac(n,d)} × ${i} =`,n:n*i,d:d,type:'fraction',mixed:false};
        }
        case 2:{
            const[n,d]=randFrac(8,10);
            const i=R(2,6);
            return{q:`${frac(n,d)} ÷ ${i} =`,n:n,d:d*i,type:'fraction',mixed:false};
        }
        case 3:{
            const[n1,d1]=randFrac(8,12);
            const[n2,d2]=randFrac(8,12);
            return{q:`${frac(n1,d1)} × ${frac(n2,d2)} =`,n:n1*n2,d:d1*d2,type:'fraction',mixed:false};
        }
        case 4:{
            const w1=R(1,3),d1=R(3,6),n1=R(1,d1-1);
            const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);
            const i1=w1*d1+n1,i2=w2*d2+n2;
            return{q:`${mixedFrac(w1,n1,d1)} × ${mixedFrac(w2,n2,d2)} =`,n:i1*i2,d:d1*d2,type:'fraction',mixed:true};
        }
        case 5:{
            const[n1,d1]=randFrac(6,8);
            const[n2,d2]=randFrac(6,8);
            const[n3,d3]=randFrac(6,8);
            return{q:`${frac(n1,d1)} × ${frac(n2,d2)} × ${frac(n3,d3)} =`,n:n1*n2*n3,d:d1*d2*d3,type:'fraction',mixed:false};
        }
        case 6:{
            // 改良された分数の大小比較問題
            const type=R(1,4);
            switch(type){
                case 1:{
                    // 1/3 と 1/3×1/2 の比較
                    const[n1,d1]=[1,3];
                    const[n2,d2]=[1,2];
                    const leftValue=n1/d1;
                    const rightValue=(n1*n2)/(d1*d2);
                    return{q:`次の分数を比べて、どちらが大きいか答えてください：${frac(n1,d1)} と ${frac(n1,d1)}×${frac(n2,d2)}`,left:leftValue,right:rightValue,type:'comparison'};
                }
                case 2:{
                    // 1/3×3/4 と 1/3 の比較
                    const[n1,d1]=[1,3];
                    const[n2,d2]=[3,4];
                    const leftValue=(n1*n2)/(d1*d2);
                    const rightValue=n1/d1;
                    return{q:`次の分数を比べて、どちらが大きいか答えてください：${frac(n1,d1)}×${frac(n2,d2)} と ${frac(n1,d1)}`,left:leftValue,right:rightValue,type:'comparison'};
                }
                case 3:{
                    // 1/3 と 1/3×2 の比較
                    const[n1,d1]=[1,3];
                    const i=2;
                    const leftValue=n1/d1;
                    const rightValue=(n1*i)/d1;
                    return{q:`次の分数を比べて、どちらが大きいか答えてください：${frac(n1,d1)} と ${frac(n1,d1)}×${i}`,left:leftValue,right:rightValue,type:'comparison'};
                }
                case 4:{
                    // 通常の分数比較
                    const[n1,d1]=randFrac(8,12);
                    const[n2,d2]=randFrac(8,12);
                    return{q:`次の分数を比べて、どちらが大きいか答えてください：${frac(n1,d1)} と ${frac(n2,d2)}`,left:n1*d2,right:n2*d1,type:'comparison'};
                }
            }
        }
        case 7:{
            const[n,d]=randFrac(8,12);
            return{q:`${frac(n,d)} の逆数は？`,n:d,d:n,type:'fraction',mixed:false};
        }
        case 8:{
            const hours=R(1,3);
            const[n,d]=randFrac(6,12);
            return{q:`${hours}時間の${frac(n,d)}は何分ですか？`,n:hours*60*n,d:d,u:"分",type:'fraction',mixed:false};
        }
        case 9:{
            const total=R(20,40);
            const[n,d]=randFrac(6,12);
            return{q:`${total}個のりんごの${frac(n,d)}を食べました。残りは何個ですか？`,n:total*(d-n),d:d,u:"個",type:'fraction',mixed:false};
        }
    }
}

function newProblem(){
    state.prob=generateProblem(state.level);
    state.unit=state.prob.u||"";
    $("q").innerHTML=state.prob.q;
    $("monster").textContent=monsters[state.level-1];
    $("lv").textContent=state.level;
    $("lvInfo").textContent=lvNames[state.level-1];
    
    // 単位表示の更新
    if(state.unit){
        $("fUnit").textContent=state.unit;
        $("mUnit").textContent=state.unit;
        $("nUnit").textContent=state.unit;
        $("fUnit").style.display="block";
        $("mUnit").style.display="block";
        $("nUnit").style.display="block";
    }else{
        $("fUnit").style.display="none";
        $("mUnit").style.display="none";
        $("nUnit").style.display="none";
    }
    
    // 入力フィールドのクリア
    $("n").value="";
    $("d").value="";
    $("mw").value="";
    $("mn").value="";
    $("md").value="";
    $("norm").value="";
    
    // 表示の制御
    if(state.prob.type==='comparison'){
        $("answerSections").style.display="none";
        $("comparisonInput").style.display="block";
        state.selectedComparison=null;
        document.querySelectorAll('.comparison-btn').forEach(btn=>btn.classList.remove('selected'));
    }else{
        $("answerSections").style.display="flex";
        $("comparisonInput").style.display="none";
        $("mixedSection").style.display=state.prob.mixed?"block":"none";
    }
    
    $("wrong").style.display="none";
    
    // カーソル位置を分母に設定
    setTimeout(() => {
        if(state.prob.type!=='comparison'){
            $("d").focus();
        }
    }, 100);
}

function selectMode(mode){
    state.mode=mode;
    state.score=0;
    state.level=1;
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.hiddenQ=0;
    state.sessionPoints=0;
    state.completed=new Set();
    state.selectCorrectCount=0;
    
    if(mode==='hidden'&&!hiddenStageAvailable){
        alert('隠しステージはまとめモードをクリアすると解放されます！');
        return;
    }
    
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    
    updateLevelIndicator();
    updateProgressBar();
    updateModeDisplay();
    
    if(mode==='select'){
        $("levelSelectBtn").style.display="inline-block";
        $("selectQ").style.display="inline";
    }else{
        $("levelSelectBtn").style.display="none";
        $("selectQ").style.display="none";
    }
    
    if(mode==='summary'){
        $("totalQ").style.display="inline";
    }else if(mode==='hidden'){
        $("hiddenQ").style.display="inline";
    }else{
        $("totalQ").style.display="none";
        $("hiddenQ").style.display="none";
    }
    
    startTimer();
    newProblem();
}

// 修正：選択されたレベルを正しく設定し、選択モードで開始
function selectLevel(level){
    $("start").style.display="none";
    $("levelSelect").style.display="none";
    $("game").style.display="block";
    
    // 選択モードの初期化
    state.mode='select';
    state.score=0;
    state.level=level; // 重要：選択されたレベルを設定
    state.lvCount=0;
    state.totalQ=0;
    state.qNum=0;
    state.hiddenQ=0;
    state.sessionPoints=0;
    state.completed=new Set();
    state.selectCorrectCount=0;
    
    updateLevelIndicator();
    updateProgressBar();
    updateModeDisplay();
    
    $("levelSelectBtn").style.display="inline-block";
    $("selectQ").style.display="inline";
    $("totalQ").style.display="none";
    $("hiddenQ").style.display="none";
    
    newProblem();
}

function showLevelSelect(){
    loadClearedLevels();
    updateLevelSelectDisplay();
    $("start").style.display="none";
    $("levelSelect").style.display="block";
}

function backToStart(){
    stopTimer();
    $("start").style.display="block";
    $("levelSelect").style.display="none";
    $("game").style.display="none";
    $("gameover").style.display="none";
    $("clear").style.display="none";
    $("hiddenClear").style.display="none";
    $("levelClear").style.display="none";
}

function backToLevelSelect(){
    loadClearedLevels();
    updateLevelSelectDisplay();
    $("levelSelect").style.display="block";
    $("game").style.display="none";
    $("levelClear").style.display="none";
}

function updateLevelIndicator(){
    const indicator=$("levelIndicator");
    indicator.innerHTML="";
    
    if(state.mode==='hidden'){
        for(let i=1;i<=10;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            dot.textContent=i;
            if(i<=state.hiddenQ)dot.classList.add("completed");
            if(i===state.hiddenQ+1)dot.classList.add("current");
            indicator.appendChild(dot);
        }
    }else{
        for(let i=1;i<=9;i++){
            const dot=document.createElement("div");
            dot.className="level-dot";
            dot.textContent=i;
            if(state.completed.has(i))dot.classList.add("completed");
            if(i===state.level)dot.classList.add("current");
            indicator.appendChild(dot);
        }
    }
}

function updateProgressBar(){
    const progressBar=$("progressBar");
    progressBar.className=`progress-bar ${state.mode}`;
    
    if(state.mode==='practice'){
        const progress=(state.lvCount/5)*100;
        progressBar.style.width=progress+"%";
        $("levelProgress").textContent=`このレベル: ${state.lvCount}/5問正解`;
    }else if(state.mode==='summary'){
        const progress=(state.totalQ/45)*100;
        progressBar.style.width=progress+"%";
        $("levelProgress").textContent=`全体進捗: ${state.totalQ}/45問`;
    }else if(state.mode==='hidden'){
        const progress=(state.hiddenQ/10)*100;
        progressBar.style.width=progress+"%";
        $("levelProgress").textContent=`隠しステージ: ${state.hiddenQ}/10問`;
    }else{
        const progress=(state.selectCorrectCount/10)*100;
        progressBar.style.width=progress+"%";
        $("levelProgress").textContent=`連続正解: ${state.selectCorrectCount}/10問`;
    }
}

function updateModeDisplay(){
    const modeDisplay=$("modeDisplay");
    switch(state.mode){
        case 'practice':
            modeDisplay.innerHTML='<div class="mode-info practice"><strong>📚 練習モード</strong><br>5問連続正解でレベルアップ！</div>';
            break;
        case 'summary':
            modeDisplay.innerHTML='<div class="mode-info summary"><strong>🎯 まとめモード</strong><br>全45問ノーミスでクリア！</div>';
            break;
        case 'select':
            modeDisplay.innerHTML='<div class="mode-info select"><strong>🎮 選択モード</strong><br>10問連続正解でレベルクリア！</div>';
            break;
        case 'hidden':
            modeDisplay.innerHTML='<div class="mode-info hidden"><strong>👑 隠しステージ</strong><br>超高難度の分数問題に挑戦！</div>';
            break;
    }
}

function selectComparison(btn,choice){
    document.querySelectorAll('.comparison-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    state.selectedComparison=choice;
}

function submitComparison(){
    if(!state.selectedComparison){
        alert('選択肢を選んでください');
        return;
    }
    
    let correct=false;
    if(state.selectedComparison==='left'&&state.prob.left>state.prob.right)correct=true;
    if(state.selectedComparison==='right'&&state.prob.left<state.prob.right)correct=true;
    if(state.selectedComparison==='equal'&&state.prob.left===state.prob.right)correct=true;
    
    if(correct){
        handleCorrect();
    }else{
        const correctAnswer=state.prob.left>state.prob.right?'左がわ':
                          state.prob.left<state.prob.right?'右がわ':'同じ';
        handleWrong(correctAnswer);
    }
}

function submitFraction(){
    const n=parseInt($("n").value);
    const d=parseInt($("d").value);
    if(isNaN(n)||isNaN(d)||d<=0){
        alert('正しい数値を入力してください');
        return;
    }
    checkFractionAnswer(n,d);
}

function submitMixed(){
    const w=parseInt($("mw").value)||0;
    const n=parseInt($("mn").value)||0;
    const d=parseInt($("md").value);
    if(isNaN(d)||d<=0){
        alert('正しい数値を入力してください');
        return;
    }
    const improperN=w*d+n;
    checkFractionAnswer(improperN,d);
}

function submitNormal(){
    const input=$("norm").value.trim();
    if(!input){
        alert('答えを入力してください');
        return;
    }
    
    let userAnswer;
    if(input.includes('/')){
        const parts=input.split('/');
        if(parts.length!==2){
            alert('分数は「分子/分母」の形で入力してください');
            return;
        }
        const n=parseInt(parts[0]);
        const d=parseInt(parts[1]);
        if(isNaN(n)||isNaN(d)||d<=0){
            alert('正しい数値を入力してください');
            return;
        }
        checkFractionAnswer(n,d);
        return;
    }else{
        userAnswer=parseFloat(input);
        if(isNaN(userAnswer)){
            alert('正しい数値を入力してください');
            return;
        }
    }
    
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    const correctDecimal=correctN/correctD;
    
    if(Math.abs(userAnswer-correctDecimal)<0.001){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

function checkFractionAnswer(userN,userD){
    const[correctN,correctD]=simplify(state.prob.n,state.prob.d);
    
    // 約分されているかチェック
    const userGcd = gcd(Math.abs(userN), Math.abs(userD));
    
    if(userGcd > 1){
        // 約分されていない場合は間違いとして扱う
        const[simplifiedN,simplifiedD]=simplify(userN,userD);
        $("almostMsg").style.display="block";
        $("almostText").textContent=`${userN}/${userD} は約分すると ${simplifiedN}/${simplifiedD} になります`;
        $("correctAnswer").style.display="block";
        $("correctText").textContent=formatAnswer(state.prob.n,state.prob.d,state.unit);
        $("wrong").style.display="block";
        return;
    }
    
    // 約分されている場合のみ正解判定
    if(userN===correctN&&userD===correctD){
        handleCorrect();
    }else{
        handleWrong(formatAnswer(state.prob.n,state.prob.d,state.unit));
    }
}

async function handleCorrect(){
    state.score++;
    $("score").textContent=state.score;
    
    const points=calculateCorrectPoints(state.level,state.mode);
    await addPoints(points);
    
    $("monster").classList.add("correct");
    setTimeout(()=>$("monster").classList.remove("correct"),1500);
    
    if(state.mode==='practice'){
        state.lvCount++;
        if(state.lvCount>=5){
            state.completed.add(state.level);
            const levelPoints=calculateLevelPoints(state.level,state.mode);
            await addPoints(levelPoints);
            
            $("monster").classList.add("level-up");
            setTimeout(()=>$("monster").classList.remove("level-up"),3000);
            
            if(state.level<9){
                state.level++;
                state.lvCount=0;
            }else{
                setTimeout(()=>{
                    alert('練習モード全レベル完了！おめでとうございます！');
                    backToStart();
                },2000);
                return;
            }
        }
    }else if(state.mode==='summary'){
        state.totalQ++;
        if(state.totalQ>=45){
            stopTimer();
            const clearTime=getElapsedTime();
            enableHiddenStage();
            setTimeout(()=>showClear(clearTime),1000);
            return;
        }else if(state.totalQ%5===0){
            state.level++;
        }
    }else if(state.mode==='hidden'){
        state.hiddenQ++;
        if(state.hiddenQ>=10){
            stopTimer();
            setTimeout(()=>showHiddenClear(),1000);
            return;
        }
    }else if(state.mode==='select'){
        state.selectQCount++;
        state.selectCorrectCount++;
        
        // 10問連続正解でレベルクリア
        if(state.selectCorrectCount>=10){
            state.clearedLevels.add(state.level);
            saveClearedLevels();
            
            const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
            await addPoints(levelClearPoints);
            
            setTimeout(()=>showLevelClear(),1000);
            return;
        }
    }
    
    updateLevelIndicator();
    updateProgressBar();
    setTimeout(newProblem,1500);
}

function handleWrong(correctAnswer){
    $("almostMsg").style.display="none";
    $("correctAnswer").style.display="block";
    $("correctText").textContent=correctAnswer;
    
    if(state.mode==='practice'){
        $("practiceMsg").style.display="block";
        $("selectMsg").style.display="none";
        $("backToSelectBtn").style.display="none";
        state.lvCount=0;
    }else if(state.mode==='summary'||state.mode==='hidden'){
        stopTimer();
        const finalTime=getElapsedTime();
        setTimeout(()=>showGameOver(finalTime),2000);
        return;
    }else{
        $("practiceMsg").style.display="none";
        $("selectMsg").style.display="block";
        $("backToSelectBtn").style.display="inline-block";
        state.selectCorrectCount=0; // 選択モードで間違えたら連続正解カウントをリセット
    }
    
    $("monster").classList.add("wrong");
    setTimeout(()=>$("monster").classList.remove("wrong"),1000);
    $("wrong").style.display="block";
    updateProgressBar();
}

function retry(){
    $("wrong").style.display="none";
    newProblem();
}

// 修正：選択モードでは同じレベルの次の問題を出題
function next(){
    $("wrong").style.display="none";
    // 選択モードでは「つぎへ」ボタンでレベルを変更しない
    newProblem();
}

async function showGameOver(finalTime){
    $("game").style.display="none";
    $("gameover").style.display="block";
    $("finalLv").textContent=state.level;
    $("finalScore1").textContent=state.score;
    
    if(state.mode==='summary'||state.mode==='hidden'){
        $("finalTime").style.display="block";
        $("finalTimeValue").textContent=formatTime(finalTime);
        
        if(state.score > 0){
            const gameoverPoints=state.level*20;
            $("gameoverPoints").style.display="block";
            $("gameoverPointsValue").textContent=gameoverPoints;
            await addPoints(gameoverPoints);
        }
        
        displayGlobalRanking('#globalRankingGameover','#myGlobalRankGameover');
    }
}

async function showClear(clearTime){
    $("game").style.display="none";
    $("clear").style.display="block";
    $("finalScore2").textContent=state.score;
    $("clearTimeValue").textContent=formatTime(clearTime);
    
    const clearPoints=calculateClearPoints(clearTime);
    $("pointsEarned").style.display="block";
    $("earnedPoints").textContent=clearPoints;
    await addPoints(clearPoints);
    
    try{localStorage.setItem('summaryCleared','true')}catch(e){}
    
    createFireworks();
    displayGlobalRanking('#globalRankingClear','#myGlobalRankClear');
    
    $("hiddenStageUnlock").style.display="block";
}

async function showLevelClear(){
    $("game").style.display="none";
    $("levelClear").style.display="block";
    $("clearedLevel").textContent=state.level;
    
    const levelClearPoints=calculateLevelPoints(state.level,state.mode) * 2;
    $("levelClearPointsValue").textContent=levelClearPoints;
    
    createFireworks();
}

async function showHiddenClear(){
    $("game").style.display="none";
    $("hiddenClear").style.display="block";
    $("hiddenFinalScore").textContent=state.score;
    
    createMasterFireworks();
    unlockTitle('fractionMaster');
    
    const hiddenPoints=3000;
    $("hiddenPointsEarned").style.display="block";
    $("hiddenEarnedPoints").textContent=hiddenPoints;
    await addPoints(hiddenPoints);
    
    displayGlobalRanking('#globalRankingHidden','#myGlobalRankHidden');
}

function restart(){
    state.sessionPoints=0;
    backToStart();
}

function createFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<20;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*2+"s";
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),3000);
    }
    
    for(let i=0;i<50;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*3+"s";
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),4000);
    }
}

function createMasterFireworks(){
    const celebration=$("celebration");
    celebration.innerHTML="";
    
    for(let i=0;i<50;i++){
        const firework=document.createElement("div");
        firework.className="firework";
        firework.style.left=Math.random()*100+"%";
        firework.style.top=Math.random()*100+"%";
        firework.style.animationDelay=Math.random()*3+"s";
        firework.style.background=`hsl(${Math.random()*360},100%,50%)`;
        celebration.appendChild(firework);
        
        setTimeout(()=>firework.remove(),5000);
    }
    
    for(let i=0;i<100;i++){
        const sparkle=document.createElement("div");
        sparkle.className="sparkle";
        sparkle.style.left=Math.random()*100+"%";
        sparkle.style.top=Math.random()*100+"%";
        sparkle.style.animationDelay=Math.random()*5+"s";
        sparkle.style.background=`hsl(${Math.random()*360},100%,70%)`;
        celebration.appendChild(sparkle);
        
        setTimeout(()=>sparkle.remove(),6000);
    }
}

function unlockTitle(titleKey){
    if(titles[titleKey]){
        titles[titleKey].unlocked=true;
        try{localStorage.setItem('titles',JSON.stringify(titles))}catch(e){}
    }
}

try{
    if(localStorage.getItem('summaryCleared')==='true'){
        enableHiddenStage();
    }
}catch(e){}

document.addEventListener('keydown',function(e){
    if(e.key==='Enter'&&$("game").style.display==="block"){
        if($("comparisonInput").style.display==="block"){
            submitComparison();
        }else if($("n").value&&$("d").value){
            submitFraction();
        }else if($("norm").value){
            submitNormal();
        }
    }
});
</script>
</body>
</html>
