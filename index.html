<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>千早算数クエスト - 6年生分数版</title>
<style>
body{font-family:Arial,sans-serif;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:transform 0.3s;margin:20px 0}
.monster.level-up{animation:levelUp 2s}
.monster.correct{animation:correct 1s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1)}50%{transform:scale(2)rotate(180deg);color:#ff0}100%{transform:scale(1)rotate(360deg);color:gold}}
@keyframes correct{0%{transform:scale(1)}50%{transform:scale(1.3);color:#0f0}100%{transform:scale(1);color:gold}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.question{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:10px}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;background:#4caf50;transition:width 0.3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:40px;margin:30px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:20px;min-width:200px}
.answer-section h3{margin:0 0 15px 0;color:#2196f3;font-size:18px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-input input{width:80px;text-align:center;margin:2px}
.fraction-line{width:90px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0}
.mixed-input input{width:60px;text-align:center}
.normal-input{display:flex;flex-direction:column;align-items:center;gap:10px;margin:10px 0}
.normal-input input{width:120px;text-align:center}
.unit-display{font-size:16px;font-weight:bold;color:#666;margin-top:5px}
.submit-buttons{display:flex;justify-content:center;gap:20px;margin:20px 0}
.submit-btn{padding:15px 30px;font-size:18px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer}
.submit-btn:hover{background:#45a049}
.submit-btn:disabled{background:#ccc;cursor:not-allowed}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:15px;border-radius:8px;margin:15px 0;font-size:18px;border:2px solid #4caf50}
.comparison-options{display:flex;justify-content:center;gap:20px;margin:20px 0}
.comparison-btn{padding:15px 30px;font-size:18px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:30px}
.level-indicator{display:flex;justify-content:center;gap:10px;margin:20px 0;flex-wrap:wrap}
.level-dot{width:30px;height:30px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
</style>
</head>
<body>
<h1>🧮 千早算数クエスト - 6年生分数版</h1>

<div id="start">
<h2>モードを選択してください</h2>
<div class="info">
<div class="mode-info practice">
<h3>📚 練習モード</h3>
<p>• 各レベルで5問連続正解で次のレベルへ</p>
<p>• 間違えたらそのレベルのカウントが0に戻る</p>
<p>• ライフ制度なし、何度でも挑戦可能</p>
</div>
<div class="mode-info summary">
<h3>🎯 まとめモード</h3>
<p>• 全9レベル×各5問＝計45問に挑戦</p>
<p>• 一問でも間違えるとゲームオーバー</p>
<p>• 真の実力が試される緊張感あふれるモード</p>
</div>
</div>

<button class="mode-btn practice" onclick="selectMode('practice')">練習モード</button>
<button class="mode-btn" onclick="selectMode('summary')">まとめモード</button>

<div style="margin-top:30px">
<input type="number" id="grade" value="6" min="1" max="6" placeholder="学年">年
<input type="number" id="class" min="1" max="10" placeholder="組">組
<input type="number" id="number" min="1" max="40" placeholder="番号">番
</div>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>レベル<span id="lv">1</span>/9 - <span id="lvInfo"></span></div>
<div class="progress">
<div class="progress-bar" id="progressBar"></div>
</div>
<div id="levelProgress"></div>
</div>

<div class="level-indicator" id="levelIndicator"></div>

<div class="monster" id="monster">📊</div>
<div class="question" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>分数で答える</h3>
<div class="fraction-input">
<input type="number" id="numerator" placeholder="分子" min="0">
<div class="fraction-line"></div>
<input type="number" id="denominator" placeholder="分母" min="1">
</div>
<div id="fractionUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitFraction()">分数で答える</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>帯分数で答える</h3>
<div class="mixed-input">
<input type="number" id="mixedWhole" placeholder="整数" min="0">
<div class="fraction-input" style="margin:0">
<input type="number" id="mixedNumerator" placeholder="分子" min="0">
<div class="fraction-line"></div>
<input type="number" id="mixedDenominator" placeholder="分母" min="1">
</div>
</div>
<div id="mixedUnit" class="unit-display" style="display:none"></div>
<button class="submit-btn" onclick="submitMixed()">帯分数で答える</button>
</div>

<div class="answer-section">
<h3>整数か小数で答える</h3>
<div class="normal-input">
<input type="text" id="normalAnswer" placeholder="答えを入力">
<div id="normalUnit" class="unit-display" style="display:none"></div>
</div>
<button class="submit-btn" onclick="submitNormal()">整数・小数で答える</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="submitComparison('left')">左の式</button>
<button class="comparison-btn" onclick="submitComparison('right')">右の式</button>
<button class="comparison-btn" onclick="submitComparison('equal')">同じ</button>
</div>

<div id="wrong" style="display:none">
<p id="wrongMsg">まちがいです。</p>
<div id="correctAnswerDisplay" class="correct-answer" style="display:none">
<strong>正解：</strong><span id="correctAnswerText"></span>
</div>
<div id="practiceWrongMsg" style="display:none">
<p>このレベルのカウントが0に戻ります。頑張って！</p>
</div>
<button onclick="retry()" id="retryBtn">もう一度</button>
<button onclick="next()" id="nextBtn">つぎへ</button>
</div>

<div class="status">
<span id="statusText">スコア: <span id="score">0</span></span>
<span id="totalQuestions" style="display:none"> / 45問中</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ゲームオーバー</h1>
<div class="monster" style="font-size:120px">😵</div>
<h2 id="gameoverMsg">残念！</h2>
<div class="info">
<p>到達レベル: <span id="finalLevel"></span>/9</p>
<p>正解数: <span id="finalScore1"></span>問</p>
</div>
<button onclick="restart()">もう一度</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>🎉 ゲームクリア！ 🎉</h1>
<div class="monster" style="font-size:120px">👑</div>
<h2>おめでとう！全レベル制覇！</h2>
<div class="info">最終スコア: <span id="finalScore2"></span>問正解</div>
<button onclick="restart()">もう一度</button>
</div>

<script>
const $=id=>document.getElementById(id);
let score=0,level=1,ans,qNum=0,info="",currentProblem,currentUnit="",gameMode="",levelCorrectCount=0,totalQuestions=0;
const monsters=["📊","🔢","✖️","🔄","⭐","⚖️","💡","🏃","👑"];
const levelNames=["分数×整数","分数÷整数","分数×分数","帯分数×帯分数","分数×分数×分数","大小比較","逆数","時間の分数","分数の文章題"];
const completedLevels=new Set();

function gcd(a,b){return b?gcd(b,a%b):a}
function simplify(n,d){const g=gcd(Math.abs(n),Math.abs(d));return[n/g,d/g]}
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function randFrac(maxN=10,maxD=10){let n,d;do{n=rand(1,maxN);d=rand(2,maxD)}while(gcd(n,d)!==1||n>=d);return[n,d]}
function mixed2improper(w,n,d){return[w*d+n,d]}
function improper2mixed(n,d){return[Math.floor(n/d),n%d,d]}

// 分数を横線付きで表示する関数
function formatFraction(numerator, denominator) {
    return `<span class="fraction-display"><span class="numerator">${numerator}</span><span class="fraction-bar"></span><span class="denominator">${denominator}</span></span>`;
}

// 帯分数を横線付きで表示する関数（真分数のみ）
function formatMixedNumber(whole, numerator, denominator) {
    if (numerator >= denominator) {
        // 仮分数の場合、帯分数に変換
        const additionalWhole = Math.floor(numerator / denominator);
        const newNumerator = numerator % denominator;
        whole += additionalWhole;
        numerator = newNumerator;
    }
    if (numerator === 0) {
        return `${whole}`;
    }
    return `${whole} ${formatFraction(numerator, denominator)}`;
}

function selectMode(mode) {
    gameMode = mode;
    const g = $("grade").value || "6";
    const c = $("class").value || "？";
    const n = $("number").value || "？";
    info = `${g}年${c}組${n}番`;
    
    $("start").style.display = "none";
    $("game").style.display = "block";
    
    score = 0;
    level = 1;
    qNum = 0;
    levelCorrectCount = 0;
    totalQuestions = 0;
    completedLevels.clear();
    
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function updateDisplay() {
    $("lv").textContent = level;
    $("lvInfo").textContent = levelNames[level - 1];
    $("score").textContent = score;
    $("monster").textContent = monsters[level - 1];
    
    const progressBar = $("progressBar");
    
    if (gameMode === 'practice') {
        $("modeDisplay").innerHTML = '<div class="mode-info practice"><strong>📚 練習モード</strong></div>';
        $("levelProgress").textContent = `このレベル: ${levelCorrectCount}/5問正解`;
        progressBar.className = "progress-bar practice";
        progressBar.style.width = `${(levelCorrectCount / 5) * 100}%`;
        $("totalQuestions").style.display = "none";
    } else {
        $("modeDisplay").innerHTML = '<div class="mode-info summary"><strong>🎯 まとめモード</strong></div>';
        $("levelProgress").textContent = `問題 ${totalQuestions + 1}/45`;
        progressBar.className = "progress-bar summary";
        progressBar.style.width = `${(totalQuestions / 45) * 100}%`;
        $("totalQuestions").style.display = "inline";
        $("totalQuestions").textContent = ` / 45問中`;
    }
}

function updateLevelIndicator() {
    const indicator = $("levelIndicator");
    indicator.innerHTML = "";
    
    for (let i = 1; i <= 9; i++) {
        const dot = document.createElement("div");
        dot.className = "level-dot";
        dot.textContent = i;
        
        if (completedLevels.has(i)) {
            dot.classList.add("completed");
        } else if (i === level) {
            dot.classList.add("current");
        }
        
        indicator.appendChild(dot);
    }
}

function generateProblem(level){
switch(level){
case 1:{ // 分数×整数
const [n,d]=randFrac(9,12);
const i=rand(2,8);
const [rn,rd]=simplify(n*i,d);
return {q:`${formatFraction(n,d)} × ${i} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(n*i)/d,allowMixed:false};
}
case 2:{ // 分数÷整数
const [n,d]=randFrac(8,10);
const i=rand(2,6);
const [rn,rd]=simplify(n,d*i);
return {q:`${formatFraction(n,d)} ÷ ${i} =`,a:`${rn}━${rd}`,type:'fraction',decimal:n/(d*i),allowMixed:false};
}
case 3:{ // 分数×分数
const [n1,d1]=randFrac(8,12);
const [n2,d2]=randFrac(8,12);
const [rn,rd]=simplify(n1*n2,d1*d2);
return {q:`${formatFraction(n1,d1)} × ${formatFraction(n2,d2)} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(n1*n2)/(d1*d2),allowMixed:false};
}
case 4:{ // 帯分数×帯分数 - 分数部分は真分数のみ
const w1=rand(1,3),d1=rand(3,6);
const n1=rand(1,d1-1); // 真分数になるように
const w2=rand(1,2),d2=rand(3,5);
const n2=rand(1,d2-1); // 真分数になるように
const [i1,id1]=mixed2improper(w1,n1,d1);
const [i2,id2]=mixed2improper(w2,n2,d2);
const [rn,rd]=simplify(i1*i2,id1*id2);
return {q:`${formatMixedNumber(w1,n1,d1)} × ${formatMixedNumber(w2,n2,d2)} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(i1*i2)/(id1*id2),allowMixed:true};
}
case 5:{ // 分数×分数×分数
const [n1,d1]=randFrac(6,8);
const [n2,d2]=randFrac(6,8);
const [n3,d3]=randFrac(6,8);
const [rn,rd]=simplify(n1*n2*n3,d1*d2*d3);
return {q:`${formatFraction(n1,d1)} × ${formatFraction(n2,d2)} × ${formatFraction(n3,d3)} =`,a:`${rn}━${rd}`,type:'fraction',decimal:(n1*n2*n3)/(d1*d2*d3),allowMixed:false};
}
case 6:{ // 大小比較 - 分数の積と分数の関係
const [n1,d1]=randFrac(8,12);
const [n2,d2]=randFrac(8,12);
const val1=n1/d1,val2=n2/d2;

// より明確な比較のための問題パターン
const patterns = [
    // 分数×分数 vs 分数
    {
        expr1: `${formatFraction(n1,d1)} × ${formatFraction(n2,d2)}`,
        expr2: `${formatFraction(n1,d1)}`,
        result1: val1*val2,
        result2: val1
    },
    // 分数×整数 vs 分数
    {
        expr1: `${formatFraction(n1,d1)} × ${rand(2,4)}`,
        expr2: `${formatFraction(n1,d1)}`,
        result1: val1*rand(2,4),
        result2: val1
    }
];

const pattern = patterns[rand(0,1)];
let answer;
if(Math.abs(pattern.result1-pattern.result2)<0.0001)answer='equal';
else answer=pattern.result1>pattern.result2?'left':'right';
return {q:`${pattern.expr1} と ${pattern.expr2} どちらが大きいですか？`,a:answer,type:'comparison',left:pattern.expr1,right:pattern.expr2,allowMixed:false};
}
case 7:{ // 逆数
const [n,d]=randFrac(8,12);
return {q:`${formatFraction(n,d)} の逆数を求めましょう`,a:`${d}━${n}`,type:'fraction',decimal:d/n,allowMixed:false};
}
case 8:{ // 時間・分数
const problems=[
()=>{
const m=rand(10,50);
const [rn,rd]=simplify(m,60);
return {q:`${m}分は何時間ですか？`,a:`${rn}━${rd}`,unit:"時間",type:'fraction',decimal:m/60,allowMixed:false}
},
()=>{
const s=rand(15,55);
const [rn,rd]=simplify(s,60);
return {q:`${s}秒は何分ですか？`,a:`${rn}━${rd}`,unit:"分",type:'fraction',decimal:s/60,allowMixed:false}
},
()=>{
const h=rand(15,45);
const [rn,rd]=simplify(h,24);
return {q:`${h}時間は何日ですか？`,a:`${rn}━${rd}`,unit:"日",type:'fraction',decimal:h/24,allowMixed:false}
}
];
return problems[rand(0,2)]();
}
case 9:{ // 分数の文章題 - 分数×分数、または整数÷分数
const problems=[
// 分数×分数の問題
()=>{
const [n1,d1]=randFrac(6,10);
const [n2,d2]=randFrac(4,8);
const [rn,rd]=simplify(n1*n2,d1*d2);
return {q:`全体の${formatFraction(n1,d1)}の${formatFraction(n2,d2)}は、全体のどれだけですか？`,a:`${rn}━${rd}`,type:'fraction',decimal:(n1*n2)/(d1*d2),allowMixed:false};
},
// 整数÷分数の問題
()=>{
const wholeNum=rand(2,8);
const [n,d]=randFrac(4,8);
const [rn,rd]=simplify(wholeNum*d,n);
return {q:`${wholeNum}個のお菓子を${formatFraction(n,d)}個ずつ分けると、何人に分けられますか？`,a:`${rn}━${rd}`,unit:"人",type:'fraction',decimal:(wholeNum*d)/n,allowMixed:true};
},
// 距離と分数の問題
()=>{
const distance=rand(3,8);
const [n,d]=randFrac(3,6);
const [rn,rd]=simplify(distance*d,n);
return {q:`${distance}kmの道のりを${formatFraction(n,d)}kmずつ歩きます。何回に分けて歩けますか？`,a:`${rn}━${rd}`,unit:"回",type:'fraction',decimal:(distance*d)/n,allowMixed:true};
}
];
return problems[rand(0,2)]();
}
}
}

function nextQ() {
    if (gameMode === 'practice') {
        if (levelCorrectCount >= 5) {
            completedLevels.add(level);
            if (level >= 9) {
                showClear();
                return;
            }
            level++;
            levelCorrectCount = 0;
            $("monster").classList.add("level-up");
            setTimeout(() => $("monster").classList.remove("level-up"), 2000);
            updateLevelIndicator();
        }
    } else { // summary mode
        if (level >= 9 && qNum >= 5) {
            showClear();
            return;
        }
        
        if (qNum >= 5) {
            completedLevels.add(level);
            level++;
            qNum = 0;
            $("monster").classList.add("level-up");
            setTimeout(() => $("monster").classList.remove("level-up"), 2000);
            updateLevelIndicator();
        }
    }

    currentProblem = generateProblem(level);
    $("q").innerHTML = currentProblem.q;
    ans = currentProblem.a;
    currentUnit = currentProblem.unit || "";

    // Clear inputs
    $("numerator").value = "";
    $("denominator").value = "";
    $("mixedWhole").value = "";
    $("mixedNumerator").value = "";
    $("mixedDenominator").value = "";
    $("normalAnswer").value = "";
    $("wrong").style.display = "none";
    $("correctAnswerDisplay").style.display = "none";

    // Show/hide answer sections based on problem type
    if (currentProblem.type === 'comparison') {
        $("answerSections").style.display = "none";
        $("comparisonInput").style.display = "block";
    } else {
        $("answerSections").style.display = "flex";
        $("comparisonInput").style.display = "none";
    }

    // Show mixed number section if allowed
    if (currentProblem.allowMixed) {
        $("mixedSection").style.display = "block";
    } else {
        $("mixedSection").style.display = "none";
    }

    // Show units if present
    if (currentUnit) {
        $("fractionUnit").textContent = currentUnit;
        $("fractionUnit").style.display = "block";
        $("mixedUnit").textContent = currentUnit;
        $("mixedUnit").style.display = "block";
        $("normalUnit").textContent = currentUnit;
        $("normalUnit").style.display = "block";
    } else {
        $("fractionUnit").style.display = "none";
        $("mixedUnit").style.display = "none";
        $("normalUnit").style.display = "none";
    }

    updateDisplay();
    $("numerator").focus();
}

function submitFraction(){
const num=parseInt($("numerator").value)||0;
const den=parseInt($("denominator").value)||1;
if(den===0){alert("分母は0にできません");return}
const[sn,sd]=simplify(num,den);
const userAns=`${sn}━${sd}`;
checkAnswer(userAns);
}

function submitMixed(){
const whole=parseInt($("mixedWhole").value)||0;
const num=parseInt($("mixedNumerator").value)||0;
const den=parseInt($("mixedDenominator").value)||1;
if(den===0){alert("分母は0にできません");return}
if(num===0&&whole===0){alert("答えを入力してください");return}

// Convert mixed to improper fraction
const [improperNum,improperDen]=mixed2improper(whole,num,den);
const[sn,sd]=simplify(improperNum,improperDen);
const userAns=`${sn}━${sd}`;
checkAnswer(userAns);
}

function submitNormal(){
let userAns=$("normalAnswer").value.trim();

// Convert decimal to fraction if needed for comparison
if(currentProblem.decimal && !isNaN(parseFloat(userAns))){
const userDecimal=parseFloat(userAns);
if(Math.abs(userDecimal-currentProblem.decimal)<0.0001){
checkAnswer(ans); // Correct decimal answer
return;
}
}

// Check if it's an integer that matches
if(currentProblem.decimal && userAns==Math.round(currentProblem.decimal)){
checkAnswer(ans);
return;
}

checkAnswer(userAns);
}

function submitComparison(choice){
checkAnswer(choice);
}

function checkAnswer(userAns) {
    if (userAns === ans) {
        score++;
        if (gameMode === 'practice') {
            levelCorrectCount++;
        } else {
            qNum++;
            totalQuestions++;
        }
        
        $("monster").classList.add("correct");
        setTimeout(() => $("monster").classList.remove("correct"), 1000);
        setTimeout(nextQ, 1500);
    } else {
        if (gameMode === 'practice') {
            levelCorrectCount = 0; // Reset level progress
            $("practiceWrongMsg").style.display = "block";
        } else {
            showGameOver(); // Immediate game over in summary mode
            return;
        }
        
        $("monster").classList.add("wrong");
        setTimeout(() => $("monster").classList.remove("wrong"), 1000);
        
        $("answerSections").style.display = "none";
        $("comparisonInput").style.display = "none";
        $("wrong").style.display = "block";
        $("correctAnswerDisplay").style.display = "none";
        
        if (gameMode === 'practice') {
            $("wrongMsg").textContent = "まちがいです。このレベルのカウントが0に戻ります。";
        }
    }
}

function retry() {
    if (currentProblem.type === 'comparison') {
        $("comparisonInput").style.display = "block";
    } else {
        $("answerSections").style.display = "flex";
    }
    $("wrong").style.display = "none";
    $("correctAnswerDisplay").style.display = "none";
    $("practiceWrongMsg").style.display = "none";
    
    // Clear inputs
    $("numerator").value = "";
    $("denominator").value = "";
    $("mixedWhole").value = "";
    $("mixedNumerator").value = "";
    $("mixedDenominator").value = "";
    $("normalAnswer").value = "";
    
    updateDisplay();
    $("numerator").focus();
}

function next() {
    displayCorrectAnswer();
    setTimeout(() => {
        if (gameMode === 'summary') {
            qNum++;
            totalQuestions++;
        }
        nextQ();
    }, 2000);
}

function displayCorrectAnswer() {
    let displayAnswer;
    if (currentProblem.type === 'comparison') {
        const choices = { 'left': '左の式', 'right': '右の式', 'equal': '同じ' };
        displayAnswer = choices[ans];
    } else {
        // Convert ━ back to proper fraction display for answer
        displayAnswer = ans.replace(/(\d+)━(\d+)/g, (match, num, den) => {
            return formatFraction(num, den);
        }) + (currentUnit || "");
    }
    $("correctAnswerText").innerHTML = displayAnswer;
    $("correctAnswerDisplay").style.display = "block";
}

function showGameOver() {
    $("game").style.display = "none";
    $("gameover").style.display = "block";
    $("finalLevel").textContent = level;
    $("finalScore1").textContent = score;
    
    if (gameMode === 'summary') {
        $("gameoverMsg").textContent = "一問でも間違えるとゲームオーバー！";
    } else {
        $("gameoverMsg").textContent = "練習を続けて頑張ろう！";
    }
}

function showClear() {
    $("game").style.display = "none";
    $("clear").style.display = "block";
    $("finalScore2").textContent = score;
    document.body.classList.add("clear-screen");
}

function restart() {
    location.reload();
}

// Event listeners for Enter key
$("normalAnswer").addEventListener("keypress", e => { if (e.key === "Enter") submitNormal() });
$("numerator").addEventListener("keypress", e => { if (e.key === "Enter") $("denominator").focus() });
$("denominator").addEventListener("keypress", e => { if (e.key === "Enter") submitFraction() });
$("mixedWhole").addEventListener("keypress", e => { if (e.key === "Enter") $("mixedNumerator").focus() });
$("mixedNumerator").addEventListener("keypress", e => { if (e.key === "Enter") $("mixedDenominator").focus() });
$("mixedDenominator").addEventListener("keypress", e => { if (e.key === "Enter") submitMixed() });
</script>
</body>
</html>
