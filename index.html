<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 6å¹´ç”Ÿåˆ†æ•°ç‰ˆ</title>
<style>
body{font-family:Arial;text-align:center;background:#f0f8ff;margin:0;padding:20px}
.monster{font-size:80px;transition:all 0.3s;margin:20px 0}
.monster.level-up{animation:levelUp 2s}
.monster.correct{animation:correct 1s}
.monster.wrong{animation:wrong 1s}
@keyframes levelUp{0%{transform:scale(1)}50%{transform:scale(2)rotate(180deg);color:#ff0}100%{transform:scale(1)rotate(360deg);color:gold}}
@keyframes correct{0%{transform:scale(1)}50%{transform:scale(1.3);color:#0f0}100%{transform:scale(1);color:gold}}
@keyframes wrong{0%{transform:scale(1)}25%{transform:scale(1.2)rotate(-10deg);color:#f00}50%{transform:scale(1.2)rotate(10deg);color:#f00}75%{transform:scale(1.2)rotate(-10deg);color:#f00}100%{transform:scale(1);color:#333}}
.q{font-size:24px;margin:20px;padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
button{margin:10px;padding:12px 24px;font-size:16px;border:none;border-radius:8px;background:#4CAF50;color:white;cursor:pointer}
button:hover{background:#45a049}
.mode-btn{background:#2196f3;padding:15px 30px;font-size:18px;margin:20px}
.mode-btn:hover{background:#1976d2}
.mode-btn.practice{background:#ff9800}
.mode-btn.practice:hover{background:#f57c00}
input{font-size:18px;padding:10px;border:2px solid #ddd;border-radius:5px;margin:5px;width:70px;text-align:center}
input:focus{border-color:#2196f3;outline:none;box-shadow:0 0 5px rgba(33,150,243,0.3)}
.status{margin:15px 0;font-size:18px}
.progress{background:#e0e0e0;border-radius:10px;margin:15px 0;height:20px;overflow:hidden}
.progress-bar{height:100%;transition:width 0.3s}
.progress-bar.practice{background:#ff9800}
.progress-bar.summary{background:#f44336}
.info{padding:15px;background:white;border-radius:10px;margin:15px 0}
.mode-info{padding:10px;margin:10px 0;border-radius:8px;font-size:16px}
.mode-info.practice{background:#fff3e0;color:#f57c00;border:2px solid #ff9800}
.mode-info.summary{background:#ffebee;color:#d32f2f;border:2px solid #f44336}
.clear-screen{background:linear-gradient(45deg,#ff9a9e,#fecfef);animation:rainbow 2s infinite}
@keyframes rainbow{0%,100%{background:linear-gradient(45deg,#ff9a9e,#fecfef)}50%{background:linear-gradient(45deg,#a8e6cf,#dcedc1)}}
.gameover{background:#ffebee;color:#d32f2f;padding:20px;border-radius:10px;margin:20px 0}
.answer-sections{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
.answer-section{background:white;border:2px solid #2196f3;border-radius:15px;padding:15px;min-width:180px}
.answer-section h3{margin:0 0 10px 0;color:#2196f3;font-size:16px}
.fraction-input{display:flex;flex-direction:column;align-items:center;gap:5px;margin:10px 0}
.fraction-line{width:80px;height:2px;background:#333;margin:3px 0}
.mixed-input{display:flex;align-items:center;justify-content:center;gap:8px;margin:10px 0}
.comparison-options{display:flex;justify-content:center;gap:15px;margin:20px 0}
.comparison-btn{padding:12px 25px;font-size:16px;background:#e3f2fd;border:2px solid #2196f3;border-radius:8px;cursor:pointer}
.comparison-btn:hover{background:#2196f3;color:white}
.fraction-display{display:inline-block;text-align:center;vertical-align:middle;margin:0 5px}
.fraction-display .numerator{display:block;line-height:1.2}
.fraction-display .denominator{display:block;line-height:1.2}
.fraction-display .fraction-bar{display:block;border-top:2px solid #333;margin:2px 0;min-width:25px}
.level-indicator{display:flex;justify-content:center;gap:8px;margin:15px 0;flex-wrap:wrap}
.level-dot{width:25px;height:25px;border-radius:50%;background:#e0e0e0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold}
.level-dot.completed{background:#4caf50;color:white}
.level-dot.current{background:#2196f3;color:white;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.correct-answer{background:#e8f5e8;color:#2e7d32;padding:10px;border-radius:8px;margin:10px 0;font-size:16px;border:2px solid #4caf50}
.error-msg{background:#ffebee;color:#d32f2f;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #f44336}
.almost-msg{background:#fff3e0;color:#f57c00;padding:10px;border-radius:8px;margin:10px 0;border:2px solid #ff9800}
.unit{font-size:14px;font-weight:bold;color:#666;margin-top:5px}
</style>
</head>
<body>
<h1>ğŸ§® åƒæ—©ç®—æ•°ã‚¯ã‚¨ã‚¹ãƒˆ - 6å¹´ç”Ÿåˆ†æ•°ç‰ˆ</h1>

<div id="start">
<h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
<div class="info">
<div class="mode-info practice"><h3>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3><p>â€¢ å„ãƒ¬ãƒ™ãƒ«ã§5å•é€£ç¶šæ­£è§£ã§æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸<br>â€¢ é–“é•ãˆãŸã‚‰ãã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚‹</p></div>
<div class="mode-info summary"><h3>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</h3><p>â€¢ å…¨9ãƒ¬ãƒ™ãƒ«Ã—å„5å•ï¼è¨ˆ45å•ã«æŒ‘æˆ¦<br>â€¢ ä¸€å•ã§ã‚‚é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</p></div>
</div>
<button class="mode-btn practice" onclick="selectMode('practice')">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
<button class="mode-btn" onclick="selectMode('summary')">ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<div id="game" style="display:none">
<div class="info">
<div id="modeDisplay"></div>
<div>ãƒ¬ãƒ™ãƒ«<span id="lv">1</span>/9 - <span id="lvInfo"></span></div>
<div class="progress"><div class="progress-bar" id="progressBar"></div></div>
<div id="levelProgress"></div>
</div>
<div class="level-indicator" id="levelIndicator"></div>
<div class="monster" id="monster">ğŸ“Š</div>
<div class="q" id="q"></div>

<div id="answerSections" class="answer-sections">
<div class="answer-section">
<h3>åˆ†æ•°ã§ç­”ãˆã‚‹ï¼ˆç´„åˆ†å¿…é ˆï¼‰</h3>
<div class="fraction-input">
<input type="number" id="n" placeholder="åˆ†å­" min="0">
<div class="fraction-line"></div>
<input type="number" id="d" placeholder="åˆ†æ¯" min="1">
</div>
<div id="fUnit" class="unit" style="display:none"></div>
<button onclick="submitFraction()">åˆ†æ•°ã§ç­”ãˆã‚‹</button>
</div>

<div class="answer-section" id="mixedSection" style="display:none">
<h3>å¸¯åˆ†æ•°ã§ç­”ãˆã‚‹ï¼ˆç´„åˆ†å¿…é ˆï¼‰</h3>
<div class="mixed-input">
<input type="number" id="mw" placeholder="æ•´æ•°" min="0" style="width:50px">
<div class="fraction-input" style="margin:0">
<input type="number" id="mn" placeholder="åˆ†å­" min="0" style="width:50px">
<div class="fraction-line"></div>
<input type="number" id="md" placeholder="åˆ†æ¯" min="1" style="width:50px">
</div>
</div>
<div id="mUnit" class="unit" style="display:none"></div>
<button onclick="submitMixed()">å¸¯åˆ†æ•°ã§ç­”ãˆã‚‹</button>
</div>

<div class="answer-section">
<h3>æ•´æ•°ãƒ»å°æ•°ã§ç­”ãˆã‚‹</h3>
<input type="text" id="norm" placeholder="ç­”ãˆã‚’å…¥åŠ›" style="width:100px">
<div id="nUnit" class="unit" style="display:none"></div>
<button onclick="submitNormal()">æ•´æ•°ãƒ»å°æ•°ã§ç­”ãˆã‚‹</button>
</div>
</div>

<div id="comparisonInput" style="display:none" class="comparison-options">
<button class="comparison-btn" onclick="submitComparison('left')">å·¦ã®å¼</button>
<button class="comparison-btn" onclick="submitComparison('right')">å³ã®å¼</button>
<button class="comparison-btn" onclick="submitComparison('equal')">åŒã˜</button>
</div>

<div id="wrong" style="display:none">
<div id="almostMsg" class="almost-msg" style="display:none"><strong>ãŠã—ã„ï¼ç´„åˆ†ã§ãã¾ã™</strong><br><span id="almostText"></span></div>
<div id="wrongMsg" class="error-msg">ã¾ã¡ãŒã„ã§ã™ã€‚</div>
<div id="correctAnswer" class="correct-answer" style="display:none"><strong>æ­£è§£ï¼š</strong><span id="correctText"></span></div>
<div id="practiceMsg" style="display:none"><p>ã“ã®ãƒ¬ãƒ™ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆãŒ0ã«æˆ»ã‚Šã¾ã™ã€‚é ‘å¼µã£ã¦ï¼</p></div>
<button onclick="retry()">ã‚‚ã†ä¸€åº¦</button>
<button onclick="next()">ã¤ãã¸</button>
</div>

<div class="status">
<span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
<span id="totalQ" style="display:none"> / 45å•ä¸­</span>
</div>
</div>

<div id="gameover" style="display:none" class="gameover">
<h1>ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
<div class="monster" style="font-size:120px">ğŸ˜µ</div>
<h2>æ®‹å¿µï¼</h2>
<div class="info"><p>åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="finalLv"></span>/9</p><p>æ­£è§£æ•°: <span id="finalScore1"></span>å•</p></div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<div id="clear" style="display:none" class="clear-screen">
<h1>ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</h1>
<div class="monster" style="font-size:120px">ğŸ‘‘</div>
<h2>ãŠã‚ã§ã¨ã†ï¼å…¨ãƒ¬ãƒ™ãƒ«åˆ¶è¦‡ï¼</h2>
<div class="info">æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="finalScore2"></span>å•æ­£è§£</div>
<button onclick="restart()">ã‚‚ã†ä¸€åº¦</button>
</div>

<script>
const $ = id => document.getElementById(id);
const s = {score:0,level:1,prob:null,unit:"",mode:"",lvCount:0,totalQ:0,qNum:0,completed:new Set()};
const C = {
    monsters:["ğŸ“Š","ğŸ”¢","ğŸ”²","ğŸ”„","â­","âš–ï¸","ğŸ’¡","ğŸƒ","ğŸ‘‘"],
    lvNames:["åˆ†æ•°Ã—æ•´æ•°","åˆ†æ•°Ã·æ•´æ•°","åˆ†æ•°Ã—åˆ†æ•°","å¸¯åˆ†æ•°Ã—å¸¯åˆ†æ•°","åˆ†æ•°Ã—åˆ†æ•°Ã—åˆ†æ•°","å¤§å°æ¯”è¼ƒ","é€†æ•°","æ™‚é–“ã®åˆ†æ•°","åˆ†æ•°ã®æ–‡ç« é¡Œ"]
};

const gcd = (a,b) => b ? gcd(b,a%b) : a;
const R = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
const simplify = (n,d) => {if(d<0){n=-n;d=-d;}const g=gcd(Math.abs(n),Math.abs(d));return[n/g,d/g];};
const randFrac = (maxN=10,maxD=10) => {let n,d;do{n=R(1,maxN);d=R(2,maxD);}while(gcd(n,d)!==1||n>=d);return[n,d];};
const frac = (n,d) => `<span class="fraction-display"><span class="numerator">${n}</span><span class="fraction-bar"></span><span class="denominator">${d}</span></span>`;
const mixedFrac = (w,n,d) => {if(n>=d){w+=Math.floor(n/d);n=n%d;}return n===0?`${w}`:`${w} ${frac(n,d)}`;};
const formatAnswer = (n,d,u="") => {const[sn,sd]=simplify(n,d);return sd===1?sn+u:`${sn}/${sd}`+u;};

function setFocus() {
    setTimeout(() => {
        const target = s.prob?.type === 'comparison' ? document.querySelector('.comparison-btn') :
                      $("mixedSection").style.display === "block" ? $("md") : $("d");
        if(target) {target.focus(); if(target.select) target.select();}
    }, 100);
}

document.addEventListener('keydown', e => {
    if(e.key === 'Enter' && e.target.tagName === 'INPUT') {
        e.preventDefault();
        if(['n','d'].includes(e.target.id)) submitFraction();
        else if(['mw','mn','md'].includes(e.target.id)) submitMixed();
        else if(e.target.id === 'norm') submitNormal();
    }
    if(s.prob?.type === 'comparison') {
        if(e.key === '1') submitComparison('left');
        else if(e.key === '2') submitComparison('right');
        else if(e.key === '3') submitComparison('equal');
    }
    if($("wrong").style.display !== "none") {
        if(e.key === 'Enter' || e.key === ' ') retry();
        else if(e.key === 'n' || e.key === 'N') next();
    }
});

function selectMode(m) {
    s.mode = m;
    s.score = s.level = s.qNum = s.lvCount = s.totalQ = 0;
    s.level = 1;
    s.completed.clear();
    $("start").style.display = "none";
    $("game").style.display = "block";
    updateDisplay();
    updateLevelIndicator();
    nextQ();
}

function updateDisplay() {
    $("lv").textContent = s.level;
    $("lvInfo").textContent = C.lvNames[s.level-1];
    $("score").textContent = s.score;
    $("monster").textContent = C.monsters[s.level-1];
    const bar = $("progressBar");
    if(s.mode === 'practice') {
        $("modeDisplay").innerHTML = '<div class="mode-info practice"><strong>ğŸ“š ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent = `ã“ã®ãƒ¬ãƒ™ãƒ«: ${s.lvCount}/5å•æ­£è§£`;
        bar.className = "progress-bar practice";
        bar.style.width = `${(s.lvCount/5)*100}%`;
        $("totalQ").style.display = "none";
    } else {
        $("modeDisplay").innerHTML = '<div class="mode-info summary"><strong>ğŸ¯ ã¾ã¨ã‚ãƒ¢ãƒ¼ãƒ‰</strong></div>';
        $("levelProgress").textContent = `å•é¡Œ ${s.totalQ+1}/45`;
        bar.className = "progress-bar summary";
        bar.style.width = `${(s.totalQ/45)*100}%`;
        $("totalQ").style.display = "inline";
        $("totalQ").textContent = " / 45å•ä¸­";
    }
}

function updateLevelIndicator() {
    const ind = $("levelIndicator");
    ind.innerHTML = "";
    for(let i=1; i<=9; i++) {
        const dot = document.createElement("div");
        dot.className = "level-dot";
        dot.textContent = i;
        if(s.completed.has(i)) dot.classList.add("completed");
        else if(i === s.level) dot.classList.add("current");
        ind.appendChild(dot);
    }
}

const problemGenerators = {
    1: () => {const[n,d]=randFrac(9,12);const i=R(2,8);return{q:`${frac(n,d)} Ã— ${i} =`,n:n*i,d:d,type:'fraction',mixed:false};},
    2: () => {const[n,d]=randFrac(8,10);const i=R(2,6);return{q:`${frac(n,d)} Ã· ${i} =`,n:n,d:d*i,type:'fraction',mixed:false};},
    3: () => {const[n1,d1]=randFrac(8,12);const[n2,d2]=randFrac(8,12);return{q:`${frac(n1,d1)} Ã— ${frac(n2,d2)} =`,n:n1*n2,d:d1*d2,type:'fraction',mixed:false};},
    4: () => {const w1=R(1,3),d1=R(3,6),n1=R(1,d1-1);const w2=R(1,2),d2=R(3,5),n2=R(1,d2-1);const i1=w1*d1+n1,i2=w2*d2+n2;return{q:`${mixedFrac(w1,n1,d1)} Ã— ${mixedFrac(w2,n2,d2)} =`,n:i1*i2,d:d1*d2,type:'fraction',mixed:true};},
    5: () => {const[n1,d1]=randFrac(6,8);const[n2,d2]=randFrac(6,8);const[n3,d3]=randFrac(6,8);return{q:`${frac(n1,d1)} Ã— ${frac(n2,d2)} Ã— ${frac(n3,d3)} =`,n:n1*n2*n3,d:d1*d2*d3,type:'fraction',mixed:false};},
    6: () => {const[n1,d1]=randFrac(8,12);const[n2,d2]=randFrac(8,12);const v1=n1/d1,v2=n2/d2;const mult=R(2,4);const patterns=[{e1:`${frac(n1,d1)} Ã— ${frac(n2,d2)}`,e2:`${frac(n1,d1)}`,v1:v1*v2,v2:v1},{e1:`${frac(n1,d1)} Ã— ${mult}`,e2:`${frac(n1,d1)}`,v1:v1*mult,v2:v1}];const p=patterns[R(0,1)];return{q:`${p.e1} ã¨ ${p.e2} ã©ã¡ã‚‰ãŒå¤§ãã„ã§ã™ã‹ï¼Ÿ<br><small>ï¼ˆ1:å·¦ã®å¼ 2:å³ã®å¼ 3:åŒã˜ï¼‰</small>`,a:Math.abs(p.v1-p.v2)<0.0001?'equal':p.v1>p.v2?'left':'right',type:'comparison',mixed:false};},
    7: () => {const[n,d]=randFrac(8,12);return{q:`${frac(n,d)} ã®é€†æ•°ã‚’æ±‚ã‚ã¾ã—ã‚‡ã†`,n:d,d:n,type:'fraction',mixed:false};},
    8: () => {const patterns=[()=>({q:`${R(10,50)}åˆ†ã¯ä½•æ™‚é–“ã§ã™ã‹ï¼Ÿ`,n:R(10,50),d:60,u:"æ™‚é–“",type:'fraction',mixed:false}),()=>({q:`${R(15,55)}ç§’ã¯ä½•åˆ†ã§ã™ã‹ï¼Ÿ`,n:R(15,55),d:60,u:"åˆ†",type:'fraction',mixed:false}),()=>({q:`${R(15,45)}æ™‚é–“ã¯ä½•æ—¥ã§ã™ã‹ï¼Ÿ`,n:R(15,45),d:24,u:"æ—¥",type:'fraction',mixed:false})];return patterns[R(0,2)]();},
    9: () => {const patterns=[()=>{const t=R(12,24);const[n,d]=randFrac(4,8);return{q:`${t}å€‹ã®ãŠè“å­ã®${frac(n,d)}ã¯ä½•å€‹ã§ã™ã‹ï¼Ÿ`,n:t*n,d:d,u:"å€‹",type:'fraction',mixed:true};},()=>{const t=R(6,15);const div=R(2,5);return{q:`${t}å€‹ã®ã‚Šã‚“ã”ã‚’${div}äººã§ç­‰ã—ãåˆ†ã‘ã‚‹ã¨ã€1äººã‚ãŸã‚Šä½•å€‹ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ`,n:t,d:div,u:"å€‹",type:'fraction',mixed:true};},()=>{const[n,d]=randFrac(6,10);const w=R(8,20);return{q:`${w}mã®ãƒªãƒœãƒ³ã®${frac(n,d)}ã®é•·ã•ã¯ä½•mã§ã™ã‹ï¼Ÿ`,n:w*n,d:d,u:"m",type:'fraction',mixed:false};}];return patterns[R(0,2)]();}
};

function nextQ() {
    if(s.mode === 'practice') {
        if(s.lvCount >= 5) {
            s.completed.add(s.level);
            if(s.level >= 9) {showClear();return;}
            s.level++;
            s.lvCount = 0;
            animate("level-up");
            updateLevelIndicator();
        }
    } else {
        if(s.level >= 9 && s.qNum >= 5) {showClear();return;}
        if(s.qNum >= 5) {
            s.completed.add(s.level);
            s.level++;
            s.qNum = 0;
            animate("level-up");
            updateLevelIndicator();
        }
    }

    s.prob = problemGenerators[s.level]();
    $("q").innerHTML = s.prob.q;
    s.unit = s.prob.u || "";

    ["n","d","mw","mn","md","norm"].forEach(id => $(id).value = "");
    $("wrong").style.display = "none";

    if(s.prob.type === 'comparison') {
        $("answerSections").style.display = "none";
        $("comparisonInput").style.display = "block";
    } else {
        $("answerSections").style.display = "flex";
        $("comparisonInput").style.display = "none";
    }

    $("mixedSection").style.display = s.prob.mixed ? "block" : "none";

    const show = s.unit ? "block" : "none";
    ["fUnit","mUnit","nUnit"].forEach(id => {
        $(id).textContent = s.unit;
        $(id).style.display = show;
    });

    updateDisplay();
    setFocus();
}

function animate(cls) {
    $("monster").classList.add(cls);
    setTimeout(() => $("monster").classList.remove(cls), cls === "level-up" ? 2000 : 1000);
}

function submitFraction() {
    const num = parseInt($("n").value) || 0;
    const den = parseInt($("d").value) || 1;
    if(den === 0) {showError("åˆ†æ¯ã¯0ã«ã§ãã¾ã›ã‚“");return;}
    if(num === 0 && den === 1) {showError("åˆ†å­ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    checkAnswer(num, den);
}

function submitMixed() {
    const w = parseInt($("mw").value) || 0;
    const num = parseInt($("mn").value) || 0;
    const den = parseInt($("md").value) || 1;
    if(num === 0 && w === 0) {showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    if(den === 0) {showError("åˆ†æ¯ã¯0ã«ã§ãã¾ã›ã‚“");return;}
    if(num >= den && den > 0 && num > 0) {showError("å¸¯åˆ†æ•°ã®åˆ†å­ã¯åˆ†æ¯ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„");return;}
    checkAnswer(w * den + num, den);
}

function submitNormal() {
    const ans = $("norm").value.trim();
    if(!ans) {showError("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
    const userDec = parseFloat(ans);
    const correctDec = s.prob.n / s.prob.d;
    const isCorrect = !isNaN(userDec) && Math.abs(userDec - correctDec) < 0.0001;
    handleAnswer(isCorrect, formatAnswer(s.prob.n, s.prob.d, s.unit));
}

function submitComparison(choice) {
    handleAnswer(choice === s.prob.a, getComparisonAnswer());
}

function getComparisonAnswer() {
    const answerText = {'left':'å·¦ã®å¼ãŒå¤§ãã„','right':'å³ã®å¼ãŒå¤§ãã„','equal':'åŒã˜'};
    return answerText[s.prob.a];
}

function checkAnswer(userN, userD) {
    const[correctN,correctD] = simplify(s.prob.n, s.prob.d);
    const[userSimple,userSimpleD] = simplify(userN, userD);
    const correctAnswer = formatAnswer(s.prob.n, s.prob.d, s.unit);
    const g = gcd(Math.abs(userN), Math.abs(userD));
    const isCorrect = userSimple === correctN && userSimpleD === correctD;
    const canSimplify = g > 1;

    if(isCorrect) {
        handleAnswer(true, correctAnswer);
    } else if(canSimplify && Math.abs(userN - s.prob.n) < 0.001 && Math.abs(userD - s.prob.d) < 0.001) {
        $("almostMsg").style.display = "block";
        $("almostText").textContent = `${userN}/${userD} â†’ ${formatAnswer(userN, userD, s.unit)}`;
        $("wrongMsg").style.display = "none";
        $("correctAnswer").style.display = "none";
        $("wrong").style.display = "block";
    } else {
        handleAnswer(false, correctAnswer);
    }
}

function handleAnswer(isCorrect, correctAnswer) {
    if(isCorrect) {
        s.score++;
        if(s.mode === 'practice') s.lvCount++;
        else s.qNum++;
        s.totalQ++;
        animate("correct");
        setTimeout(() => nextQ(), 1000);
    } else {
        animate("wrong");
        $("correctAnswer").style.display = "block";
        $("correctText").textContent = correctAnswer;
        $("almostMsg").style.display = "none";
        $("wrongMsg").style.display = "block";
        if(s.mode === 'practice') {
            s.lvCount = 0;
            $("practiceMsg").style.display = "block";
        } else {
            showGameOver();
            return;
        }
        $("wrong").style.display = "block";
    }
}

function showError(msg) {
    $("wrongMsg").textContent = msg;
    $("correctAnswer").style.display = "none";
    $("almostMsg").style.display = "none";
    $("practiceMsg").style.display = "none";
    $("wrong").style.display = "block";
}

function retry() {
    $("wrong").style.display = "none";
    ["n","d","mw","mn","md","norm"].forEach(id => $(id).value = "");
    setFocus();
}

function next() {
    nextQ();
}

function showGameOver() {
    $("game").style.display = "none";
    $("finalLv").textContent = s.level;
    $("finalScore1").textContent = s.score;
    $("gameover").style.display = "block";
}

function showClear() {
    $("game").style.display = "none";
    $("finalScore2").textContent = s.score;
    $("clear").style.display = "block";
}

function restart() {
    location.reload();
}
</script>
</body>
</html>
